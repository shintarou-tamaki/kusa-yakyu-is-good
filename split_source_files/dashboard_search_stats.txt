# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»æ¤œç´¢ãƒ»çµ±è¨ˆæ©Ÿèƒ½ Source Code
Generated at: 2025-09-07
File count: 11 files
Purpose: Dashboard, search, and statistics features

================================================================================
FILE: src/app/dashboard/page.tsx
================================================================================

"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { useAuth } from "@/components/auth/AuthProvider";
import Link from "next/link";
import { useRouter } from "next/navigation";
import PersonalStats from "@/components/stats/PersonalStats";

interface Team {
  id: string;
  name: string;
  description: string;
  created_at: string;
}

interface Game {
  id: string;
  name: string;
  game_date: string;
  game_time: string | null;
  location: string | null;
  opponent_name: string;
  status: string;
  home_score: number;
  opponent_score: number;
  home_team_id: string | null;
  created_at: string;
}

interface JoinRequest {
  id: string;
  team_id: string;
  user_id: string;
  status: string;
  requested_at: string;
  teams: {
    id: string;
    name: string;
  };
}

interface UserProfile {
  display_name: string | null;
}

interface Stats {
  totalTeams: number;
  totalGames: number;
  upcomingGames: number;
  completedGames: number;
  pendingRequests: number;
}

interface PendingAttendance {
  game_id: string;
  game_name: string;
  game_date: string;
  game_time: string | null;
  team_name: string;
}

export default function DashboardPage() {
  const [teams, setTeams] = useState<Team[]>([]);
  const [games, setGames] = useState<Game[]>([]);
  const [myRequests, setMyRequests] = useState<JoinRequest[]>([]);
  const [pendingApprovals, setPendingApprovals] = useState<JoinRequest[]>([]);
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
  const [stats, setStats] = useState<Stats>({
    totalTeams: 0,
    totalGames: 0,
    upcomingGames: 0,
    completedGames: 0,
    pendingRequests: 0,
  });
  const [pendingAttendances, setPendingAttendances] = useState<
    PendingAttendance[]
  >([]);
  const [loading, setLoading] = useState(true);
  const { user } = useAuth();
  const router = useRouter();
  const supabase = createClientComponentClient();

  const [isDataLoading, setIsDataLoading] = useState(false);

  useEffect(() => {
    if (!user) {
      router.push("/login");
      return;
    }

    if (isDataLoading) return;

    const loadData = async () => {
      setIsDataLoading(true);
      await fetchUserProfile();
      await fetchDashboardData();
      setIsDataLoading(false);
    };

    loadData();
  }, [user?.id]);

  const fetchUserProfile = async () => {
    if (!user) return;

    try {
      const { data, error } = await supabase
        .from("user_profiles")
        .select("display_name")
        .eq("id", user.id)
        .single();

      if (data) {
        setUserProfile(data);
      } else if (!error) {

        const { data: newProfile } = await supabase
          .from("user_profiles")
          .insert({
            id: user.id,
            display_name: "ãƒ¦ãƒ¼ã‚¶ãƒ¼",
          })
          .select()
          .single();

        if (newProfile) {
          setUserProfile(newProfile);
        }
      }
    } catch (error) {
      console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    }
  };

  const fetchDashboardData = async () => {
    if (!user) return;

    try {

      const { data: memberData } = await supabase
        .from("team_members")
        .select(
          `
          team_id,
          teams (
            id,
            name,
            description,
            created_at
          )
        `
        )
        .eq("user_id", user.id);

      if (memberData) {
        const userTeams = memberData
          .filter((item) => item.teams)
          .map((item) => item.teams as Team);
        setTeams(userTeams);
      }

      const { data: gamesData } = await supabase
        .from("games")
        .select("*")
        .or(
          `created_by.eq.${user.id},home_team_id.in.(${
            memberData?.map((m) => m.team_id).join(",") || ""
          })`
        )
        .order("game_date", { ascending: false })
        .limit(10);

      if (gamesData) {
        setGames(gamesData);
      }

      const { data: requestsData } = await supabase
        .from("team_join_requests")
        .select(
          `
          *,
          teams (
            id,
            name
          )
        `
        )
        .eq("user_id", user.id)
        .eq("status", "pending");

      if (requestsData) {
        setMyRequests(requestsData);
      }

      const { data: ownedTeams } = await supabase
        .from("teams")
        .select("id")
        .eq("owner_id", user.id);

      if (ownedTeams && ownedTeams.length > 0) {
        const teamIds = ownedTeams.map((t) => t.id);
        const { data: approvalsData } = await supabase
          .from("team_join_requests")
          .select(
            `
            *,
            teams (
              id,
              name
            )
          `
          )
          .in("team_id", teamIds)
          .eq("status", "pending");

        if (approvalsData) {
          setPendingApprovals(approvalsData);
        }
      }

      const totalTeams = memberData?.length || 0;
      const totalGames = gamesData?.length || 0;
      const upcomingGames =
        gamesData?.filter((g) => g.status === "scheduled").length || 0;
      const completedGames =
        gamesData?.filter((g) => g.status === "completed").length || 0;
      const pendingRequests = requestsData?.length || 0;

      setStats({
        totalTeams,
        totalGames,
        upcomingGames,
        completedGames,
        pendingRequests,
      });

      if (user) {
        console.log("æœªå›ç­”å‡ºæ¬ ç¢ºèªã‚’å–å¾—é–‹å§‹");

        const { data: myTeamMembers, error: tmError } = await supabase
          .from("team_members")
          .select("id, team_id")
          .eq("user_id", user.id);

        console.log("æ‰€å±ãƒãƒ¼ãƒ :", myTeamMembers);
if (myTeamMembers && myTeamMembers.length > 0) {
  console.log("ã‚ãªãŸã®team_member_id:", myTeamMembers[0].id);
  console.log("ã‚ãªãŸã®team_id:", myTeamMembers[0].team_id);
}
        console.log("ãƒãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:", tmError);

        if (myTeamMembers && myTeamMembers.length > 0) {
          const teamIds = myTeamMembers.map((tm) => tm.team_id);
          const memberIds = myTeamMembers.map((tm) => tm.id);

          const { data: activeGames, error: gamesError } = await supabase
            .from("games")
            .select(
              `
    id,
    name,
    game_date,
    game_time,
    status,
    home_team_id,
    attendance_check_enabled
  `
            )
            .in("home_team_id", teamIds)
            .eq("attendance_check_enabled", true)
            .in("status", ["scheduled", "in_progress"])
            .gte("game_date", new Date().toISOString().split("T")[0]);

          console.log("å‡ºæ¬ ç¢ºèªãŒæœ‰åŠ¹ãªè©¦åˆ:", activeGames);
          console.log("è©¦åˆå–å¾—ã‚¨ãƒ©ãƒ¼:", gamesError);

          if (activeGames && activeGames.length > 0) {
            const gameIds = activeGames.map((g) => g.id);

            const { data: myAttendances, error: attendanceError } =
              await supabase
                .from("game_attendances")
                .select(
                  `
      id,
      game_id,
      status,
      team_member_id
    `
                )
                .in("game_id", gameIds)
                .in("team_member_id", memberIds);

            console.log("è‡ªåˆ†ã®å‡ºæ¬ ãƒ‡ãƒ¼ã‚¿:", myAttendances);
            console.log("å‡ºæ¬ å–å¾—ã‚¨ãƒ©ãƒ¼:", attendanceError);

            const pendingGames = activeGames.filter((game) => {
              const myAttendance = myAttendances?.find(
                (a) => a.game_id === game.id
              );
              return !myAttendance || myAttendance.status === "pending";
            });

            console.log("æœªå›ç­”ã®è©¦åˆ:", pendingGames);

            if (pendingGames.length > 0) {

              const uniqueTeamIds = [
                ...new Set(
                  pendingGames.map((g) => g.home_team_id).filter((id) => id)
                ),
              ];

              const { data: teamsData } = await supabase
                .from("teams")
                .select("id, name")
                .in("id", uniqueTeamIds);

              console.log("ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:", teamsData);

              const formattedPending = pendingGames.map((game: any) => {
                const team = teamsData?.find((t) => t.id === game.home_team_id);
                return {
                  game_id: game.id,
                  game_name: game.name,
                  game_date: game.game_date,
                  game_time: game.game_time,
                  team_name: team?.name || "ãƒãƒ¼ãƒ ",
                };
              });

              console.log("æ•´å½¢å¾Œã®æœªå›ç­”ãƒ‡ãƒ¼ã‚¿:", formattedPending);
              setPendingAttendances(formattedPending);
            } else {
              console.log("æœªå›ç­”ã®å‡ºæ¬ ç¢ºèªã¯ã‚ã‚Šã¾ã›ã‚“");
            }
          }
        } else {
          console.log("æ‰€å±ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“");
        }
      }
    } catch (error) {
      console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleRequestAction = async (
    requestId: string,
    action: "approved" | "rejected"
  ) => {
    try {
      const { error } = await supabase
        .from("team_join_requests")
        .update({
          status: action,
          responded_at: new Date().toISOString(),
          responded_by: user?.id,
        })
        .eq("id", requestId);

      if (error) throw error;

      setPendingApprovals((prev) => prev.filter((req) => req.id !== requestId));

      alert(
        action === "approved"
          ? "å‚åŠ ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸ"
          : "å‚åŠ ç”³è«‹ã‚’å´ä¸‹ã—ã¾ã—ãŸ"
      );

      fetchDashboardData();
    } catch (error) {
      console.error("ç”³è«‹å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
      alert("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">
            ã‚ˆã†ã“ãã€{userProfile?.display_name || "ãƒ¦ãƒ¼ã‚¶ãƒ¼"}ã•ã‚“
          </h1>
          <p className="mt-2 text-gray-600">
            è‰é‡çƒ is Goodã¸ã‚ˆã†ã“ãã€‚ä»Šæ—¥ã‚‚æ¥½ã—ãé‡çƒã‚’ã—ã¾ã—ã‚‡ã†ï¼
          </p>
        </div>

        {}
        {pendingAttendances.length > 0 && (
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div className="flex items-start">
              <div className="flex-shrink-0">
                <svg
                  className="h-5 w-5 text-yellow-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fillRule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clipRule="evenodd"
                  />
                </svg>
              </div>
              <div className="ml-3 flex-1">
                <h3 className="text-sm font-medium text-yellow-800">
                  å‡ºæ¬ ã®å›ç­”ã‚’ã—ã¦ãã ã•ã„ğŸ™‡
                </h3>
                <div className="mt-2 text-sm text-yellow-700">
                  <p className="mb-2">ä»¥ä¸‹ã®è©¦åˆã®å‡ºæ¬ ç¢ºèªãŒæœªå›ç­”ã§ã™ï¼š</p>
                  <ul className="space-y-1">
                    {pendingAttendances.map((attendance) => (
                      <li key={attendance.game_id}>
                        <Link
                          href={`/games/${attendance.game_id}`}
                          className="underline hover:text-yellow-900"
                        >
                          {new Date(attendance.game_date).toLocaleDateString(
                            "ja-JP"
                          )}
                          {attendance.game_time && ` ${attendance.game_time}`}
                          {" - "}
                          {attendance.game_name}ï¼ˆ{attendance.team_name}ï¼‰
                        </Link>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        )}

        {}
        {user && <PersonalStats userId={user.id} />}

        {}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
          <div className="bg-white rounded-lg shadow p-6">
            <div className="text-2xl font-bold text-gray-900">
              {stats.totalTeams}
            </div>
            <div className="text-sm text-gray-600">æ‰€å±ãƒãƒ¼ãƒ </div>
          </div>
          <div className="bg-white rounded-lg shadow p-6">
            <div className="text-2xl font-bold text-gray-900">
              {stats.totalGames}
            </div>
            <div className="text-sm text-gray-600">ç·è©¦åˆæ•°</div>
          </div>
          <div className="bg-white rounded-lg shadow p-6">
            <div className="text-2xl font-bold text-gray-900">
              {stats.upcomingGames}
            </div>
            <div className="text-sm text-gray-600">äºˆå®šè©¦åˆ</div>
          </div>
          <div className="bg-white rounded-lg shadow p-6">
            <div className="text-2xl font-bold text-gray-900">
              {stats.completedGames}
            </div>
            <div className="text-sm text-gray-600">å®Œäº†è©¦åˆ</div>
          </div>
          <div className="bg-white rounded-lg shadow p-6">
            <div className="text-2xl font-bold text-gray-900">
              {stats.pendingRequests}
            </div>
            <div className="text-sm text-gray-600">ç”³è«‹ä¸­</div>
          </div>
        </div>

        {}
        {pendingApprovals.length > 0 && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 className="text-lg font-semibold text-blue-900 mb-3">
              æ‰¿èªå¾…ã¡ã®å‚åŠ ç”³è«‹
            </h3>
            <div className="space-y-2">
              {pendingApprovals.map((request) => (
                <div
                  key={request.id}
                  className="flex items-center justify-between bg-white p-3 rounded"
                >
                  <div>
                    <span className="font-medium">{request.teams.name}</span>
                    ã¸ã®å‚åŠ ç”³è«‹ãŒã‚ã‚Šã¾ã™
                  </div>
                  <div className="space-x-2">
                    <button
                      onClick={() =>
                        handleRequestAction(request.id, "approved")
                      }
                      className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                    >
                      æ‰¿èª
                    </button>
                    <button
                      onClick={() =>
                        handleRequestAction(request.id, "rejected")
                      }
                      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700"
                    >
                      å´ä¸‹
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {}
          <div className="bg-white rounded-lg shadow">
            <div className="px-6 py-4 border-b">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-semibold text-gray-900">
                  æ‰€å±ãƒãƒ¼ãƒ 
                </h2>
                <Link
                  href="/teams"
                  className="text-blue-600 hover:text-blue-700"
                >
                  ã™ã¹ã¦è¦‹ã‚‹ â†’
                </Link>
              </div>
            </div>
            <div className="p-6">
              {teams.length > 0 ? (
                <div className="space-y-4">
                  {teams.slice(0, 3).map((team) => (
                    <div
                      key={team.id}
                      className="border rounded-lg p-4 hover:bg-gray-50"
                    >
                      <Link
                        href={`/teams/${team.id}`}
                        className="text-lg font-medium text-blue-600 hover:text-blue-700"
                      >
                        {team.name}
                      </Link>
                      {team.description && (
                        <p className="text-sm text-gray-600 mt-1">
                          {team.description}
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500">ã¾ã ãƒãƒ¼ãƒ ã«æ‰€å±ã—ã¦ã„ã¾ã›ã‚“</p>
              )}
            </div>
          </div>

          {}
          <div className="bg-white rounded-lg shadow">
            <div className="px-6 py-4 border-b">
              <div className="flex justify-between items-center">
                <h2 className="text-xl font-semibold text-gray-900">
                  æœ€è¿‘ã®è©¦åˆ
                </h2>
                <Link
                  href="/games"
                  className="text-blue-600 hover:text-blue-700"
                >
                  ã™ã¹ã¦è¦‹ã‚‹ â†’
                </Link>
              </div>
            </div>
            <div className="p-6">
              {games.length > 0 ? (
                <div className="space-y-4">
                  {games.slice(0, 3).map((game) => (
                    <div
                      key={game.id}
                      className="border rounded-lg p-4 hover:bg-gray-50"
                    >
                      <Link
                        href={`/games/${game.id}`}
                        className="text-lg font-medium text-blue-600 hover:text-blue-700"
                      >
                        {game.name}
                      </Link>
                      <div className="mt-1 text-sm text-gray-600">
                        <p>
                          {new Date(game.game_date).toLocaleDateString("ja-JP")}
                          {game.game_time && ` ${game.game_time}`}
                        </p>
                        <p>vs {game.opponent_name}</p>
                        {game.status === "completed" && (
                          <p className="font-medium">
                            ã‚¹ã‚³ã‚¢: {game.home_score} - {game.opponent_score}
                          </p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500">è©¦åˆã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</p>
              )}
            </div>
          </div>
        </div>

        {}
        <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
          <Link
            href="/teams/create"
            className="bg-green-600 text-white text-center py-4 rounded-lg hover:bg-green-700 transition-colors"
          >
            æ–°ã—ã„ãƒãƒ¼ãƒ ã‚’ä½œæˆ
          </Link>
          <Link
            href="/games/create"
            className="bg-blue-600 text-white text-center py-4 rounded-lg hover:bg-blue-700 transition-colors"
          >
            è©¦åˆã‚’ä½œæˆ
          </Link>
          <Link
            href="/search/teams"
            className="bg-purple-600 text-white text-center py-4 rounded-lg hover:bg-purple-700 transition-colors"
          >
            ãƒãƒ¼ãƒ ã‚’æ¢ã™
          </Link>
        </div>
      </div>
    </div>
  );
}


================================================================================
FILE: src/app/dashboard/settings/page.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { useAuth } from "@/components/auth/AuthProvider";
import { useRouter } from "next/navigation";
import Link from "next/link";

export default function SettingsPage() {
  const [displayName, setDisplayName] = useState("");
  const [originalName, setOriginalName] = useState("");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  const { user } = useAuth();
  const router = useRouter();
  const supabase = createClientComponentClient();

  useEffect(() => {
    if (!user) {
      router.push("/login");
      return;
    }
    fetchProfile();
  }, [user]);

  const fetchProfile = async () => {
    try {
      const { data, error } = await supabase
        .from("user_profiles")
        .select("display_name")
        .eq("id", user?.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
      }

      if (data) {
        setDisplayName(data.display_name || "");
        setOriginalName(data.display_name || "");
      }
    } catch (error) {
      console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!displayName.trim()) {
      setError("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    if (displayName.length < 2 || displayName.length > 20) {
      setError("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯2æ–‡å­—ä»¥ä¸Š20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    if (displayName === originalName) {
      setError("å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    setSaving(true);
    setError(null);
    setMessage(null);

    try {
      const { error: updateError } = await supabase
        .from("user_profiles")
        .upsert({
          id: user?.id,
          display_name: displayName.trim(),
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'id'
        });

      if (updateError) {
        console.error("æ›´æ–°ã‚¨ãƒ©ãƒ¼:", updateError);
        setError("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }

      setOriginalName(displayName);
      setMessage("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æ›´æ–°ã—ã¾ã—ãŸ");

      setTimeout(() => setMessage(null), 3000);
    } catch (error) {
      console.error("ã‚¨ãƒ©ãƒ¼:", error);
      setError("äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        {}
        <div className="mb-6">
          <Link
            href="/dashboard"
            className="inline-flex items-center text-gray-600 hover:text-gray-900"
          >
            <svg
              className="w-5 h-5 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M15 19l-7-7 7-7"
              />
            </svg>
            ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
          </Link>
        </div>

        <div className="bg-white rounded-lg shadow p-6">
          <h1 className="text-2xl font-bold text-gray-900 mb-6">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
          </h1>

          {error && (
            <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-red-600">{error}</p>
            </div>
          )}

          {message && (
            <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
              <p className="text-green-600">{message}</p>
            </div>
          )}

          <form onSubmit={handleSubmit}>
            {}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              </label>
              <input
                type="email"
                value={user?.email || ""}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500"
                disabled
              />
            </div>

            {}
            <div className="mb-6">
              <label
                htmlFor="displayName"
                className="block text-sm font-medium text-gray-700 mb-2"
              >
                ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰
              </label>
              <input
                id="displayName"
                type="text"
                value={displayName}
                onChange={(e) => setDisplayName(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ä¾‹: é‡çƒå¤ªéƒ"
                maxLength={20}
                required
              />
              <p className="mt-1 text-xs text-gray-500">
                2ã€œ20æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„
              </p>
            </div>

            {}
            <div className="flex justify-end">
              <button
                type="submit"
                disabled={saving || !displayName.trim() || displayName === originalName}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {saving ? "ä¿å­˜ä¸­..." : "å¤‰æ›´ã‚’ä¿å­˜"}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
}


================================================================================
FILE: src/app/layout.tsx
================================================================================

import "./globals.css";
import { Inter } from "next/font/google";
import Header from "@/components/Header";
import { AuthProvider } from "@/components/auth/AuthProvider";

const inter = Inter({ subsets: ["latin"] });

export const metadata = {
  title: "è‰é‡çƒ is Good",
  description: "è‰é‡çƒãƒãƒ¼ãƒ ãƒ»è©¦åˆç®¡ç†ã®ãŸã‚ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body className={inter.className}>
        <AuthProvider>
          <Header />
          <main>{children}</main>
        </AuthProvider>
      </body>
    </html>
  );
}


================================================================================
FILE: src/app/page.tsx
================================================================================

import Link from "next/link";

export default function Home() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      {}
      <section className="relative overflow-hidden">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
          <div className="text-center">
            <h1 className="text-4xl md:text-6xl font-bold text-gray-900 mb-6">
              âš¾ï¸ è‰é‡çƒ is Good
            </h1>
            <p className="text-xl md:text-2xl text-gray-600 mb-8 max-w-3xl mx-auto">
              ãƒãƒ¼ãƒ ç®¡ç†ã‹ã‚‰è©¦åˆã®ã‚¹ã‚³ã‚¢å…¥åŠ›ã¾ã§ã€è‰é‡çƒã«å¿…è¦ãªã™ã¹ã¦ã‚’ä¸€ã¤ã®ã‚¢ãƒ—ãƒªã§
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link
                href="/login"
                className="bg-blue-600 text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-colors"
              >
                ä»Šã™ãå§‹ã‚ã‚‹
              </Link>
              <Link
                href="/search/games"
                className="border border-blue-600 text-blue-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-blue-50 transition-colors"
              >
                è©¦åˆã‚’è¦‹ã‚‹
              </Link>
            </div>
          </div>
        </div>
      </section>

      {}
      <section className="py-24 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              ä¸»ãªæ©Ÿèƒ½
            </h2>
            <p className="text-xl text-gray-600">
              è‰é‡çƒãƒãƒ¼ãƒ ã®é‹å–¶ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹è±Šå¯Œãªæ©Ÿèƒ½
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM9 9a2 2 0 11-4 0 2 2 0 014 0z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                ãƒãƒ¼ãƒ ç®¡ç†
              </h3>
              <p className="text-gray-600">
                ãƒãƒ¼ãƒ ä½œæˆã€ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ã€æ¨©é™ç®¡ç†ã¾ã§ã€‚ãƒãƒ¼ãƒ é‹å–¶ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã€‚
              </p>
            </div>

            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                è©¦åˆç®¡ç†
              </h3>
              <p className="text-gray-600">
                è©¦åˆã®ä¼ç”»ã‹ã‚‰çµæœè¨˜éŒ²ã¾ã§ã€‚å€‹äººã§ã‚‚ãƒãƒ¼ãƒ ã§ã‚‚ç°¡å˜ã«è©¦åˆã‚’ä½œæˆã€‚
              </p>
            </div>

            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-purple-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢
              </h3>
              <p className="text-gray-600">
                è¤‡æ•°ç«¯æœ«ã‹ã‚‰åŒæ™‚å…¥åŠ›å¯èƒ½ã€‚è©¦åˆã®é€²è¡Œã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…±æœ‰ã€‚
              </p>
            </div>

            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-yellow-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                æ¤œç´¢ãƒ»ç™ºè¦‹
              </h3>
              <p className="text-gray-600">
                è¿‘ãã®ãƒãƒ¼ãƒ ã‚„è©¦åˆã‚’æ¤œç´¢ã€‚æ–°ã—ã„é‡çƒä»²é–“ã¨ã®å‡ºä¼šã„ã‚’ä½œã‚Šã¾ã™ã€‚
              </p>
            </div>

            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-red-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
              </h3>
              <p className="text-gray-600">
                ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚‚ä½¿ã„ã‚„ã™ã„è¨­è¨ˆã€‚ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«æ“ä½œã€‚
              </p>
            </div>

            {}
            <div className="text-center p-6">
              <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg
                  className="w-8 h-8 text-indigo-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                  />
                </svg>
              </div>
              <h3 className="text-xl font-semibold text-gray-900 mb-2">
                å®Œå…¨ç„¡æ–™
              </h3>
              <p className="text-gray-600">
                ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’ç„¡æ–™ã§åˆ©ç”¨å¯èƒ½ã€‚è‰é‡çƒã‚’ã‚‚ã£ã¨æ¥½ã—ãã€ã‚‚ã£ã¨ç°¡å˜ã«ã€‚
              </p>
            </div>
          </div>
        </div>
      </section>

      {}
      <section className="py-24 bg-gradient-to-r from-blue-600 to-indigo-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">
            ä»Šã™ãå§‹ã‚ã¾ã—ã‚‡ã†
          </h2>
          <p className="text-xl text-blue-100 mb-8 max-w-2xl mx-auto">
            Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¾ãŸã¯ GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ç°¡å˜ã«ãƒ­ã‚°ã‚¤ãƒ³
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <Link
              href="/login"
              className="bg-white text-blue-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors"
            >
              ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆãƒ»ãƒ­ã‚°ã‚¤ãƒ³
            </Link>
            <Link
              href="/search/games"
              className="border border-white text-white px-8 py-4 rounded-lg text-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors"
            >
              ã¾ãšã¯è©¦åˆã‚’è¦‹ã¦ã¿ã‚‹
            </Link>
          </div>
        </div>
      </section>

      {}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
              <h3 className="text-lg font-semibold mb-4">âš¾ï¸ è‰é‡çƒ is Good</h3>
              <p className="text-gray-400">
                è‰é‡çƒãƒãƒ¼ãƒ ãƒ»è©¦åˆç®¡ç†ã®ãŸã‚ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
              </p>
            </div>
            <div>
              <h4 className="text-md font-semibold mb-4">ãƒªãƒ³ã‚¯</h4>
              <ul className="space-y-2">
                <li>
                  <Link
                    href="/search/games"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    è©¦åˆæ¤œç´¢
                  </Link>
                </li>
                <li>
                  <Link
                    href="/search/teams"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    ãƒãƒ¼ãƒ æ¤œç´¢
                  </Link>
                </li>
                <li>
                  <Link
                    href="/login"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    ãƒ­ã‚°ã‚¤ãƒ³
                  </Link>
                </li>
              </ul>
            </div>
            <div>
              <h4 className="text-md font-semibold mb-4">ã‚µãƒãƒ¼ãƒˆ</h4>
              <ul className="space-y-2">
                <li>
                  <a
                    href="#"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    åˆ©ç”¨è¦ç´„
                  </a>
                </li>
                <li>
                  <a
                    href="#"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
                  </a>
                </li>
                <li>
                  <a
                    href="#"
                    className="text-gray-400 hover:text-white transition-colors"
                  >
                    ãŠå•ã„åˆã‚ã›
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div className="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
            <p>&copy; 2025 è‰é‡çƒ is Good. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>
  );
}


================================================================================
FILE: src/app/search/games/page.tsx
================================================================================

import PublicGameSearch from '@/components/search/PublicGameSearch';

export default function GameSearchPage() {
  return <PublicGameSearch />;
}


================================================================================
FILE: src/app/search/teams/page.tsx
================================================================================

import PublicTeamSearch from '@/components/search/PublicTeamSearch';

export default function TeamSearchPage() {
  return <PublicTeamSearch />;
}


================================================================================
FILE: src/components/search/PublicGameSearch.tsx
================================================================================

"use client";

import React, { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { useAuth } from "@/components/auth/AuthProvider";
import Link from "next/link";

interface Game {
  id: string;
  name: string;
  game_date: string;
  game_time: string | null;
  location: string | null;
  opponent_name: string;
  status: string;
  home_score: number;
  opponent_score: number;
  record_type: string;
  is_public: boolean;
  created_at: string;
  home_team_id: string | null;
  category: 'official' | 'practice' | 'scrimmage' | null;
}

interface SearchFilters {
  keyword: string;
  status: string;
  dateFrom: string;
  dateTo: string;
  category: string;
}

export default function PublicGameSearch() {
  const [games, setGames] = useState<Game[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [userTeamIds, setUserTeamIds] = useState<string[]>([]);
  const [filters, setFilters] = useState<SearchFilters>({
    keyword: "",
    status: "",
    dateFrom: "",
    dateTo: "",
    category: "",
  });

  const { user } = useAuth();
  const supabase = createClientComponentClient();

  useEffect(() => {
    fetchUserTeams();
  }, [user]);

  useEffect(() => {
    fetchGames();
  }, [filters, userTeamIds]);

  const fetchUserTeams = async () => {
    if (!user) {
      setUserTeamIds([]);
      return;
    }

    try {
      const teamIds: string[] = [];

      const { data: ownedTeams } = await supabase
        .from("teams")
        .select("id")
        .eq("owner_id", user.id);

      if (ownedTeams) {
        teamIds.push(...ownedTeams.map((t) => t.id));
      }

      const { data: memberTeams } = await supabase
        .from("team_members")
        .select("team_id")
        .eq("user_id", user.id);

      if (memberTeams) {
        teamIds.push(...memberTeams.map((t) => t.team_id));
      }

      setUserTeamIds([...new Set(teamIds)]);
    } catch (error) {
      console.error("ãƒãƒ¼ãƒ æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  };

  const fetchGames = async () => {
    try {
      setLoading(true);
      setError(null);

      let query = supabase.from("games").select("*");

      if (user) {

        if (userTeamIds.length > 0) {
          query = query.or(
            `is_public.eq.true,home_team_id.in.(${`{${userTeamIds.join(
              ","
            )}}`}),created_by.eq.${user.id}`
          );
        } else {

          query = query.or(`is_public.eq.true,created_by.eq.${user.id}`);
        }
      } else {

        query = query.eq("is_public", true);
      }

      if (filters.status) {
        query = query.eq("status", filters.status);
      } else if (!user || userTeamIds.length === 0) {

        query = query.eq("status", "completed");
      }

      if (filters.category) {
        query = query.eq("category", filters.category);
      }

      if (filters.keyword) {
        query = query.or(
          `name.ilike.%${filters.keyword}%,opponent_name.ilike.%${filters.keyword}%,location.ilike.%${filters.keyword}%`
        );
      }

      if (filters.dateFrom) {
        query = query.gte("game_date", filters.dateFrom);
      }
      if (filters.dateTo) {
        query = query.lte("game_date", filters.dateTo);
      }

      query = query.order("game_date", { ascending: false });

      const { data, error } = await query;

      if (error) {
        throw error;
      }

      let filteredGames = data || [];

      if (!user) {

        filteredGames = filteredGames.filter((game) => game.status === 'completed');
      } else {

        filteredGames = filteredGames.filter((game) => {

          if (game.status === 'completed' || game.status === 'cancelled') {
            return true;
          }

          if (game.status === 'scheduled' || game.status === 'in_progress') {

            if (game.created_by === user.id) {
              return true;
            }

            if (game.home_team_id && userTeamIds.includes(game.home_team_id)) {
              return true;
            }

            return false;
          }

          return true;
        });
      }

      setGames(filteredGames);
    } catch (error: any) {
      console.error("è©¦åˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error?.message || error);
      setError("è©¦åˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      setLoading(false);
    }
  };

  const handleFilterChange = (key: keyof SearchFilters, value: string) => {
    setFilters((prev) => ({
      ...prev,
      [key]: value,
    }));
  };

  const resetFilters = () => {
    setFilters({
      keyword: "",
      status: "",
      dateFrom: "",
      dateTo: "",
      category: "",
    });
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case "scheduled":
        return {
          label: "äºˆå®š",
          class: "bg-gray-100 text-gray-800",
        };
      case "in_progress":
        return {
          label: "é€²è¡Œä¸­",
          class: "bg-yellow-100 text-yellow-800",
        };
      case "completed":
        return {
          label: "çµ‚äº†",
          class: "bg-green-100 text-green-800",
        };
      case "cancelled":
        return {
          label: "ä¸­æ­¢",
          class: "bg-red-100 text-red-800",
        };
      default:
        return {
          label: status,
          class: "bg-gray-100 text-gray-800",
        };
    }
  };
  const getCategoryBadge = (category: string | null) => {
    switch (category) {
      case "official":
        return {
          label: "å…¬å¼æˆ¦",
          class: "bg-red-100 text-red-800",
        };
      case "practice":
        return {
          label: "ç·´ç¿’è©¦åˆ",
          class: "bg-blue-100 text-blue-800",
        };
      case "scrimmage":
        return {
          label: "ç´…ç™½æˆ¦",
          class: "bg-green-100 text-green-800",
        };
      default:
        return null;
    }
  };

  const isTeamMember = (teamId: string | null) => {
    if (!teamId) return false;
    return userTeamIds.includes(teamId);
  };

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">è©¦åˆã‚’æ¢ã™</h1>

        {}
        <div className="bg-white rounded-lg shadow-sm p-6 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
              <label
                htmlFor="keyword"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
              </label>
              <input
                type="text"
                id="keyword"
                value={filters.keyword}
                onChange={(e) => handleFilterChange("keyword", e.target.value)}
                placeholder="è©¦åˆåã€å¯¾æˆ¦ç›¸æ‰‹ã€å ´æ‰€"
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>

            <div>
              <label
                htmlFor="status"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
              </label>
              <select
                id="status"
                value={filters.status}
                onChange={(e) => handleFilterChange("status", e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">ã™ã¹ã¦</option>
                <option value="scheduled">äºˆå®š</option>
                <option value="in_progress">é€²è¡Œä¸­</option>
                <option value="completed">çµ‚äº†</option>
                <option value="cancelled">ä¸­æ­¢</option>
              </select>
            </div>

            <div>
              <label
                htmlFor="category"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                ã‚«ãƒ†ã‚´ãƒªãƒ¼
              </label>
              <select
                id="category"
                value={filters.category}
                onChange={(e) => handleFilterChange("category", e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">ã™ã¹ã¦</option>
                <option value="official">å…¬å¼æˆ¦</option>
                <option value="practice">ç·´ç¿’è©¦åˆ</option>
                <option value="scrimmage">ç´…ç™½æˆ¦</option>
              </select>
            </div>

            <div>
              <label
                htmlFor="dateFrom"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                é–‹å§‹æ—¥
              </label>
              <input
                type="date"
                id="dateFrom"
                value={filters.dateFrom}
                onChange={(e) => handleFilterChange("dateFrom", e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>

            <div>
              <label
                htmlFor="dateTo"
                className="block text-sm font-medium text-gray-700 mb-1"
              >
                çµ‚äº†æ—¥
              </label>
              <input
                type="date"
                id="dateTo"
                value={filters.dateTo}
                onChange={(e) => handleFilterChange("dateTo", e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          <div className="mt-4 flex justify-end">
            <button
              onClick={resetFilters}
              className="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 underline"
            >
              ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </div>

        {}
        {error ? (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            {error}
          </div>
        ) : loading ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p className="text-gray-500 mt-4">æ¤œç´¢ä¸­...</p>
          </div>
        ) : games.length === 0 ? (
          <div className="text-center py-12 bg-white rounded-lg shadow-sm border border-gray-200">
            <svg
              className="mx-auto h-12 w-12 text-gray-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
            <h3 className="text-lg font-medium text-gray-900 mt-2">
              è©¦åˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            </h3>
            <p className="text-gray-500 mt-1">
              æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {games.map((game) => {
              const statusBadge = getStatusBadge(game.status);
              const isMember = isTeamMember(game.home_team_id);

              return (
                <div
                  key={game.id}
                  className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow"
                >
                  <div className="flex justify-between items-start mb-3">
                    <h3 className="text-lg font-medium text-gray-900 truncate flex-1">
                      {game.name}
                    </h3>
                    <div className="flex items-center space-x-2">
                      <span
                        className={`px-2 py-1 text-xs font-medium rounded-full ${statusBadge.class}`}
                      >
                        {statusBadge.label}
                      </span>
                      {game.category && getCategoryBadge(game.category) && (
                        <span
                          className={`px-2 py-1 text-xs font-medium rounded-full ${
                            getCategoryBadge(game.category)!.class
                          }`}
                        >
                          {getCategoryBadge(game.category)!.label}
                        </span>
                      )}
                      {isMember && (
                        <span className="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                          æ‰€å±
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="space-y-2 text-sm text-gray-600 mb-4">
                    <div className="flex items-center space-x-1">
                      <svg
                        className="w-4 h-4 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        />
                      </svg>
                      <span>
                        {new Date(game.game_date).toLocaleDateString("ja-JP")}
                      </span>
                      {game.game_time && <span>â€¢ {game.game_time}</span>}
                    </div>

                    {game.location && (
                      <div className="flex items-center space-x-1">
                        <svg
                          className="w-4 h-4 text-gray-400"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                          />
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                        </svg>
                        <span className="truncate">{game.location}</span>
                      </div>
                    )}

                    <div className="flex items-center space-x-1">
                      <svg
                        className="w-4 h-4 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                        />
                      </svg>
                      <span>vs {game.opponent_name}</span>
                    </div>
                  </div>

                  {}
                  {(game.status === "completed" ||
                    game.status === "in_progress") && (
                    <div className="flex justify-center items-center space-x-4 py-3 mb-4 bg-gray-50 rounded-md">
                      <div className="text-center">
                        <div className="text-2xl font-bold text-gray-900">
                          {game.home_score}
                        </div>
                        <div className="text-xs text-gray-500">è‡ªãƒãƒ¼ãƒ </div>
                      </div>
                      <div className="text-gray-400">-</div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-gray-900">
                          {game.opponent_score}
                        </div>
                        <div className="text-xs text-gray-500">
                          {game.opponent_name}
                        </div>
                      </div>
                    </div>
                  )}

                  <div className="flex justify-between items-center">
                    <div className="flex items-center space-x-2 text-xs text-gray-500">
                      <span
                        className={
                          game.record_type === "team"
                            ? "bg-blue-100 text-blue-700 px-2 py-1 rounded"
                            : "bg-green-100 text-green-700 px-2 py-1 rounded"
                        }
                      >
                        {game.record_type === "team"
                          ? "ãƒãƒ¼ãƒ è¨˜éŒ²"
                          : "å€‹äººè¨˜éŒ²"}
                      </span>
                      {!game.is_public && (
                        <span className="bg-gray-100 text-gray-700 px-2 py-1 rounded">
                          ğŸ”’ éå…¬é–‹
                        </span>
                      )}
                    </div>
                    <Link
                      href={`/games/${game.id}?from=search`}
                      className="text-blue-600 hover:text-blue-700 text-sm font-medium"
                    >
                      è©³ç´°ã‚’è¦‹ã‚‹ â†’
                    </Link>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}


================================================================================
FILE: src/components/search/PublicTeamSearch.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import Link from "next/link";
import { prefectures } from "@/lib/japanData";

interface Team {
  id: string;
  name: string;
  description: string;
  prefecture: string | null;
  city: string | null;
  created_at: string;
}

export default function PublicTeamSearch() {
  const [teams, setTeams] = useState<Team[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedPrefecture, setSelectedPrefecture] = useState("");
  const [error, setError] = useState<string | null>(null);
  const supabase = createClientComponentClient();

  useEffect(() => {
    fetchTeams();
  }, []);

  const fetchTeams = async () => {
    try {
      setError(null);

      let query = supabase
        .from("teams")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(20);

      if (selectedPrefecture) {
        query = query.eq("prefecture", selectedPrefecture);
      }

      const { data, error: fetchError } = await query;

      if (fetchError) {
        console.error("ãƒãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:", fetchError);
        setError("ãƒãƒ¼ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        setTeams([]);
      } else {
        setTeams(data || []);
      }
    } catch (error) {
      console.error("äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:", error);
      setError("äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = async () => {
    setLoading(true);
    try {
      let query = supabase
        .from("teams")
        .select("*")
        .order("created_at", { ascending: false });

      if (searchTerm) {
        query = query.ilike("name", `%${searchTerm}%`);
      }

      if (selectedPrefecture) {
        query = query.eq("prefecture", selectedPrefecture);
      }

      const { data, error: searchError } = await query;

      if (searchError) {
        console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", searchError);
        setError("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        setTeams([]);
      } else {
        setTeams(data || []);
      }
    } catch (error) {
      console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
      setError("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setLoading(false);
    }
  };

  const clearFilters = () => {
    setSelectedPrefecture("");
    setSearchTerm("");
    fetchTeams();
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">ãƒãƒ¼ãƒ æ¤œç´¢</h1>

        {}
        {error && (
          <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-red-600">{error}</p>
          </div>
        )}

        {}
        <div className="bg-white rounded-lg shadow p-4 mb-6">
          <div className="flex flex-col space-y-4">
            <div className="flex gap-4">
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyPress={(e) => e.key === "Enter" && handleSearch()}
                placeholder="ãƒãƒ¼ãƒ åã§æ¤œç´¢..."
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <select
                value={selectedPrefecture}
                onChange={(e) => setSelectedPrefecture(e.target.value)}
                className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">å…¨éƒ½é“åºœçœŒ</option>
                {prefectures.map((pref) => (
                  <option key={pref} value={pref}>
                    {pref}
                  </option>
                ))}
              </select>
              <button
                onClick={handleSearch}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                æ¤œç´¢
              </button>
            </div>
            {(selectedPrefecture || searchTerm) && (
              <div className="flex justify-between items-center">
                <div className="text-sm text-gray-600">
                  {selectedPrefecture && (
                    <span className="mr-2">
                      éƒ½é“åºœçœŒ: <span className="font-medium">{selectedPrefecture}</span>
                    </span>
                  )}
                  {searchTerm && (
                    <span>
                      ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <span className="font-medium">{searchTerm}</span>
                    </span>
                  )}
                </div>
                <button
                  onClick={clearFilters}
                  className="text-sm text-blue-600 hover:text-blue-700"
                >
                  ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                </button>
              </div>
            )}
          </div>
        </div>

        {}
        {teams.length === 0 ? (
          <div className="bg-white rounded-lg shadow p-8 text-center">
            <p className="text-gray-600">
              {searchTerm || selectedPrefecture
                ? "æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
                : "å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“"}
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {teams.map((team) => (
              <div
                key={team.id}
                className="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-6"
              >
                <h3 className="text-lg font-semibold text-gray-900 mb-2">
                  {team.name}
                </h3>
                <p className="text-gray-600 mb-2 line-clamp-2">
                  {team.description || "ãƒãƒ¼ãƒ ã®èª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“"}
                </p>
                {(team.prefecture || team.city) && (
                  <div className="flex items-center text-sm text-gray-500 mb-2">
                    <svg
                      className="w-4 h-4 mr-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                      />
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    <span>
                      {team.prefecture}{team.city && ` ${team.city}`}
                    </span>
                  </div>
                )}
                <div className="flex items-center justify-between mt-4">
                  <span className="text-sm text-gray-500">
                    {new Date(team.created_at).toLocaleDateString("ja-JP")}
                  </span>
                  <Link
                    href={`/teams/${team.id}`}
                    className="text-blue-600 hover:text-blue-700 text-sm font-medium"
                  >
                    è©³ç´°ã‚’è¦‹ã‚‹ â†’
                  </Link>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}


================================================================================
FILE: src/components/stats/PersonalStats.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

interface BattingStats {
  player_id: string;
  total_games: number;
  total_at_bats: number;
  total_hits: number;
  total_home_runs: number;
  total_doubles: number;
  total_triples: number;
  total_rbi: number;
  total_runs: number;
  total_walks: number;
  total_stolen_bases: number;
  batting_average: string;
  on_base_percentage: string;
  slugging_percentage: string;
  ops: string;
}

interface PitchingStats {
  player_id: string;
  total_games: number;
  total_innings: number;
  total_innings_display: string;
  total_hits_allowed: number;
  total_runs_allowed: number;
  total_earned_runs: number;
  total_strikeouts: number;
  total_walks: number;
  total_home_runs_allowed: number;
  total_wins: number;
  total_losses: number;
  total_saves: number;
  era: string;
  whip: string;
  k_per_nine: string;
  bb_per_nine: string;
  win_percentage: string;
}

interface PersonalStatsProps {
  userId: string;
}

export default function PersonalStats({ userId }: PersonalStatsProps) {
  const [battingStats, setBattingStats] = useState<BattingStats | null>(null);
  const [pitchingStats, setPitchingStats] = useState<PitchingStats | null>(
    null
  );
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<"batting" | "pitching">("batting");
  const supabase = createClientComponentClient();

  useEffect(() => {
    if (userId) {
      fetchStats();
    }
  }, [userId]);

  const fetchStats = async () => {
    setLoading(true);
    try {

      const { data: teamMemberData, error: teamMemberError } = await supabase
        .from("team_members")
        .select("id")
        .eq("user_id", userId);

      if (teamMemberError) {
        console.error("ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", teamMemberError);
        setLoading(false);
        return;
      }

      if (!teamMemberData || teamMemberData.length === 0) {
        setLoading(false);
        return;
      }

      const teamMemberIds = teamMemberData.map((tm) => tm.id);

      const { data: gamePlayerData, error: gamePlayerError } = await supabase
        .from("game_players")
        .select("id")
        .in("team_member_id", teamMemberIds);

      if (gamePlayerError) {
        console.error("ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", gamePlayerError);
        setLoading(false);
        return;
      }

      if (!gamePlayerData || gamePlayerData.length === 0) {
        setLoading(false);
        return;
      }

      const gamePlayerIds = gamePlayerData.map((gp) => gp.id);

      const { data: battingData, error: battingError } = await supabase
        .from("player_batting_stats")
        .select("*")
        .in("player_id", gamePlayerIds);

      if (battingData && battingData.length > 0) {
        const stats = calculateBattingTotals(battingData);
        setBattingStats(stats);
      }

      const { data: pitchingData, error: pitchingError } = await supabase
        .from("game_pitching_records")
        .select("*")
        .in("player_id", gamePlayerIds);

      if (pitchingData && pitchingData.length > 0) {
        const stats = calculatePitchingTotals(pitchingData);
        setPitchingStats(stats);
      }
    } catch (error) {
      console.error("æˆç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    } finally {
      setLoading(false);
    }
  };

  const calculateBattingTotals = (data: any[]): BattingStats => {
    const totals = data.reduce(
      (acc, game) => ({
        total_games: acc.total_games + 1,
        total_at_bats: acc.total_at_bats + (game.at_bats || 0),
        total_hits: acc.total_hits + (game.hits || 0),
        total_home_runs: acc.total_home_runs + (game.home_runs || 0),
        total_doubles: acc.total_doubles + (game.doubles || 0),
        total_triples: acc.total_triples + (game.triples || 0),
        total_rbi: acc.total_rbi + (game.rbi || 0),
        total_runs: acc.total_runs + (game.runs || 0),
        total_walks: acc.total_walks + (game.walks || 0),
        total_stolen_bases: acc.total_stolen_bases + (game.stolen_bases || 0),
      }),
      {
        total_games: 0,
        total_at_bats: 0,
        total_hits: 0,
        total_home_runs: 0,
        total_doubles: 0,
        total_triples: 0,
        total_rbi: 0,
        total_runs: 0,
        total_walks: 0,
        total_stolen_bases: 0,
      }
    );

    const avg =
      totals.total_at_bats > 0
        ? (totals.total_hits / totals.total_at_bats).toFixed(3)
        : ".000";

    const plateAppearances = totals.total_at_bats + totals.total_walks;
    const obp =
      plateAppearances > 0
        ? ((totals.total_hits + totals.total_walks) / plateAppearances).toFixed(
            3
          )
        : ".000";

    const totalBases =
      totals.total_hits +
      totals.total_doubles +
      totals.total_triples * 2 +
      totals.total_home_runs * 3;
    const slg =
      totals.total_at_bats > 0
        ? (totalBases / totals.total_at_bats).toFixed(3)
        : ".000";

    const ops = (parseFloat(obp) + parseFloat(slg)).toFixed(3);

    return {
      player_id: userId,
      ...totals,
      batting_average: avg,
      on_base_percentage: obp,
      slugging_percentage: slg,
      ops: ops,
    };
  };

  const calculatePitchingTotals = (data: any[]): PitchingStats => {
    console.log("å–å¾—ã—ãŸæŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿:", data);
    console.log("æœ€åˆã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:", data[0]);
    const totals = data.reduce(
      (acc, game) => ({
        total_games: acc.total_games + 1,
        total_innings: acc.total_innings + (game.innings_pitched || 0),
        total_hits_allowed: acc.total_hits_allowed + (game.hits_allowed || 0),
        total_runs_allowed: acc.total_runs_allowed + (game.runs_allowed || 0),
        total_earned_runs: acc.total_earned_runs + (game.earned_runs || 0),
        total_strikeouts: acc.total_strikeouts + (game.strikeouts || 0),
        total_walks: acc.total_walks + (game.walks || 0),
        total_home_runs_allowed:
          acc.total_home_runs_allowed + (game.home_runs_allowed || 0),
        total_wins: acc.total_wins + (game.win ? 1 : 0),
        total_losses: acc.total_losses + (game.loss ? 1 : 0),
        total_saves: acc.total_saves + (game.save ? 1 : 0),
      }),
      {
        total_games: 0,
        total_innings: 0,
        total_hits_allowed: 0,
        total_runs_allowed: 0,
        total_earned_runs: 0,
        total_strikeouts: 0,
        total_walks: 0,
        total_home_runs_allowed: 0,
        total_wins: 0,
        total_losses: 0,
        total_saves: 0,
      }
    );

    const inningsDisplay = formatInnings(totals.total_innings);

    const actualInnings =
      Math.floor(totals.total_innings) + ((totals.total_innings % 1) * 10) / 3;

    const era =
      actualInnings > 0
        ? ((totals.total_earned_runs * 7) / actualInnings).toFixed(2)
        : "0.00";

    const whip =
      actualInnings > 0
        ? (
            (totals.total_walks + totals.total_hits_allowed) /
            actualInnings
          ).toFixed(2)
        : "0.00";

    const kPerNine =
      actualInnings > 0
        ? ((totals.total_strikeouts * 7) / actualInnings).toFixed(2)
        : "0.00";

    const bbPerNine =
      actualInnings > 0
        ? ((totals.total_walks * 7) / actualInnings).toFixed(2)
        : "0.00";

    const decisions = totals.total_wins + totals.total_losses;
    const winPercentage =
      decisions > 0
        ? ((totals.total_wins / decisions) * 100).toFixed(1)
        : "0.0";

    return {
      player_id: userId,
      ...totals,
      total_innings_display: inningsDisplay,
      era: era,
      whip: whip,
      k_per_nine: kPerNine,
      bb_per_nine: bbPerNine,
      win_percentage: winPercentage,
    };
  };

  const formatInnings = (innings: number): string => {
    const wholeInnings = Math.floor(innings);
    const outs = Math.round((innings % 1) * 10);

    if (outs === 0) return `${wholeInnings}.0`;
    if (outs === 1) return `${wholeInnings}.1`;
    if (outs === 2) return `${wholeInnings}.2`;
    return `${wholeInnings}.0`;
  };

  if (loading) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div className="space-y-3">
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded"></div>
          </div>
        </div>
      </div>
    );
  }

  if (!battingStats && !pitchingStats) {
    return (
      <div className="bg-white rounded-lg shadow p-6 mb-8">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">å€‹äººæˆç¸¾</h3>
        <p className="text-gray-500 text-center py-8">
          ã¾ã æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
        </p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow mb-8">
      <div className="px-6 py-4 border-b">
        <h3 className="text-lg font-semibold text-gray-900">å€‹äººæˆç¸¾</h3>
      </div>

      {}
      <div className="border-b">
        <div className="flex">
          {battingStats && (
            <button
              onClick={() => setActiveTab("batting")}
              className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
                activeTab === "batting"
                  ? "border-blue-500 text-blue-600"
                  : "border-transparent text-gray-500 hover:text-gray-700"
              }`}
            >
              æ‰“æ’ƒæˆç¸¾
            </button>
          )}
          {pitchingStats && (
            <button
              onClick={() => setActiveTab("pitching")}
              className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
                activeTab === "pitching"
                  ? "border-blue-500 text-blue-600"
                  : "border-transparent text-gray-500 hover:text-gray-700"
              }`}
            >
              æŠ•æ‰‹æˆç¸¾
            </button>
          )}
        </div>
      </div>

      {}
      <div className="p-6">
        {activeTab === "batting" && battingStats && (
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <div>
              <dt className="text-sm text-gray-500">è©¦åˆæ•°</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_games}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">æ‰“ç‡</dt>
              <dd className="text-xl font-semibold">
                {battingStats.batting_average}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">æœ¬å¡æ‰“</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_home_runs}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">æ‰“ç‚¹</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_rbi}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">å®‰æ‰“</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_hits}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">å¾—ç‚¹</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_runs}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">ç›—å¡</dt>
              <dd className="text-xl font-semibold">
                {battingStats.total_stolen_bases}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">OPS</dt>
              <dd className="text-xl font-semibold">{battingStats.ops}</dd>
            </div>
          </div>
        )}

        {activeTab === "pitching" && pitchingStats && (
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <div>
              <dt className="text-sm text-gray-500">ç™»æ¿æ•°</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_games}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">æŠ•çƒå›</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_innings_display}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">é˜²å¾¡ç‡</dt>
              <dd className="text-xl font-semibold">{pitchingStats.era}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">å¥ªä¸‰æŒ¯</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_strikeouts}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">WHIP</dt>
              <dd className="text-xl font-semibold">{pitchingStats.whip}</dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">K/7</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.k_per_nine}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">BB/7</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.bb_per_nine}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">è¢«å®‰æ‰“</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_hits_allowed}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">å‹æ•—</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_wins}-{pitchingStats.total_losses}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">ã‚»ãƒ¼ãƒ–</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.total_saves}
              </dd>
            </div>
            <div>
              <dt className="text-sm text-gray-500">å‹ç‡</dt>
              <dd className="text-xl font-semibold">
                {pitchingStats.win_percentage}%
              </dd>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


================================================================================
FILE: src/components/stats/TeamMemberStats.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

interface MemberBattingStats {
  member_id: string;
  member_name: string;
  games: number;
  at_bats: number;
  hits: number;
  doubles: number;
  triples: number;
  home_runs: number;
  rbi: number;
  runs: number;
  walks: number;
  stolen_bases: number;
  batting_average: string;
  on_base_percentage: string;
  slugging_percentage: string;
  ops: string;
}

interface MemberPitchingStats {
  member_id: string;
  member_name: string;
  games: number;
  innings_pitched: number;
  innings_display: string;
  hits_allowed: number;
  runs_allowed: number;
  earned_runs: number;
  strikeouts: number;
  walks: number;
  home_runs_allowed: number;
  wins: number;
  losses: number;
  saves: number;
  era: string;
  whip: string;
  k_per_nine: string;
  bb_per_nine: string;
  win_percentage: string;
}

interface TeamMemberStatsProps {
  teamId: string;
}

export default function TeamMemberStats({ teamId }: TeamMemberStatsProps) {
  const [battingStats, setBattingStats] = useState<MemberBattingStats[]>([]);
  const [pitchingStats, setPitchingStats] = useState<MemberPitchingStats[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<"batting" | "pitching">("batting");
  const [sortField, setSortField] = useState<string>("batting_average");
  const [sortDirection, setSortDirection] = useState<"asc" | "desc">("desc");
  const supabase = createClientComponentClient();

  useEffect(() => {
    if (teamId) {
      fetchTeamStats();
    }
  }, [teamId]);

  const fetchTeamStats = async () => {
    setLoading(true);
    try {

      const { data: teamMembers, error: memberError } = await supabase
        .from("team_members")
        .select("id, user_id")
        .eq("team_id", teamId);

      if (memberError || !teamMembers) {
        console.error("ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:", memberError);
        setLoading(false);
        return;
      }

      console.log("ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼:", teamMembers);

      const userIds = teamMembers.map((m) => m.user_id);
      const { data: userProfiles } = await supabase
        .from("user_profiles")
        .select("id, display_name")
        .in("id", userIds);

      const userProfileMap = new Map(
        userProfiles?.map((p) => [p.id, p.display_name]) || []
      );

      const memberGamePlayerMap = new Map<
        string,
        { ids: string[]; name: string }
      >();

      for (const member of teamMembers) {

        const { data: gamePlayerData } = await supabase
          .from("game_players")
          .select("id, player_name")
          .eq("team_member_id", member.id);

        if (gamePlayerData && gamePlayerData.length > 0) {

          const displayName =
            userProfileMap.get(member.user_id) ||
            gamePlayerData[0].player_name ||
            "åå‰æœªè¨­å®š";

          memberGamePlayerMap.set(member.id, {
            ids: gamePlayerData.map((gp) => gp.id),
            name: displayName,
          });

          console.log(
            `ãƒ¡ãƒ³ãƒãƒ¼ ${displayName}: game_player IDs:`,
            gamePlayerData.map((gp) => gp.id)
          );
        }
      }

      console.log("memberGamePlayerMap:", memberGamePlayerMap);

      const { data: teamGames } = await supabase
        .from("games")
        .select("id")
        .eq("home_team_id", teamId);

      if (teamGames && teamGames.length > 0) {
        const gameIds = teamGames.map((g) => g.id);
        console.log("ãƒãƒ¼ãƒ ã®è©¦åˆID:", gameIds);

        const { data: allGamePlayers } = await supabase
          .from("game_players")
          .select("id, player_name, team_member_id")
          .in("game_id", gameIds);

        console.log("ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:", allGamePlayers);

        if (allGamePlayers) {
          const playerNameMap = new Map<string, string[]>();

          for (const gp of allGamePlayers) {
            if (!gp.team_member_id) {

              const existing = playerNameMap.get(gp.player_name) || [];
              existing.push(gp.id);
              playerNameMap.set(gp.player_name, existing);
            }
          }

          for (const [playerName, gpIds] of playerNameMap) {

            const exists = Array.from(memberGamePlayerMap.values()).some(
              (v) => v.name === playerName
            );

            if (!exists && gpIds.length > 0) {
              const pseudoId = `name_${playerName}`;
              memberGamePlayerMap.set(pseudoId, {
                ids: gpIds,
                name: playerName,
              });
              console.log(`åå‰ãƒ™ãƒ¼ã‚¹ã§è¿½åŠ : ${playerName}:`, gpIds);
            }
          }
        }
      }

      const battingStatsList: MemberBattingStats[] = [];

      for (const [memberId, playerInfo] of memberGamePlayerMap) {
        const { data: battingData, error: battingError } = await supabase
          .from("player_batting_stats")
          .select("*")
          .in("player_id", playerInfo.ids);

        console.log(`ãƒ¡ãƒ³ãƒãƒ¼ ${playerInfo.name} ã®æ‰“æ’ƒãƒ‡ãƒ¼ã‚¿:`, battingData);
        if (battingError) {
          console.error("æ‰“æ’ƒãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", battingError);
        }

        if (battingData && battingData.length > 0) {
          const stats = calculateMemberBattingTotals(
            memberId,
            playerInfo.name,
            battingData
          );
          battingStatsList.push(stats);
        }
      }

      const pitchingStatsList: MemberPitchingStats[] = [];

      for (const [memberId, playerInfo] of memberGamePlayerMap) {
        const { data: pitchingData, error: pitchingError } = await supabase
          .from("player_pitching_stats")
          .select("*")
          .in("player_id", playerInfo.ids);

        console.log(`ãƒ¡ãƒ³ãƒãƒ¼ ${playerInfo.name} ã®æŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿:`, pitchingData);
        if (pitchingError) {
          console.error("æŠ•æ‰‹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", pitchingError);
        }

        if (pitchingData && pitchingData.length > 0) {
          const stats = calculateMemberPitchingTotals(
            memberId,
            playerInfo.name,
            pitchingData
          );
          pitchingStatsList.push(stats);
        }
      }

      console.log("æ‰“æ’ƒæˆç¸¾ãƒªã‚¹ãƒˆ:", battingStatsList);
      console.log("æŠ•æ‰‹æˆç¸¾ãƒªã‚¹ãƒˆ:", pitchingStatsList);

      setBattingStats(battingStatsList);
      setPitchingStats(pitchingStatsList);
    } catch (error) {
      console.error("æˆç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    } finally {
      setLoading(false);
    }
  };

  const calculateMemberBattingTotals = (
    memberId: string,
    memberName: string,
    data: any[]
  ): MemberBattingStats => {
    const totals = data.reduce(
      (acc, game) => ({
        games: acc.games + 1,
        at_bats: acc.at_bats + (game.at_bats || 0),
        hits: acc.hits + (game.hits || 0),
        doubles: acc.doubles + (game.doubles || 0),
        triples: acc.triples + (game.triples || 0),
        home_runs: acc.home_runs + (game.home_runs || 0),
        rbi: acc.rbi + (game.rbi || 0),
        runs: acc.runs + (game.runs || 0),
        walks: acc.walks + (game.walks || 0),
        stolen_bases: acc.stolen_bases + (game.stolen_bases || 0),
      }),
      {
        games: 0,
        at_bats: 0,
        hits: 0,
        doubles: 0,
        triples: 0,
        home_runs: 0,
        rbi: 0,
        runs: 0,
        walks: 0,
        stolen_bases: 0,
      }
    );

    const avg =
      totals.at_bats > 0 ? (totals.hits / totals.at_bats).toFixed(3) : ".000";

    const plateAppearances = totals.at_bats + totals.walks;
    const obp =
      plateAppearances > 0
        ? ((totals.hits + totals.walks) / plateAppearances).toFixed(3)
        : ".000";

    const totalBases =
      totals.hits + totals.doubles + totals.triples * 2 + totals.home_runs * 3;
    const slg =
      totals.at_bats > 0 ? (totalBases / totals.at_bats).toFixed(3) : ".000";

    const ops = (parseFloat(obp) + parseFloat(slg)).toFixed(3);

    return {
      member_id: memberId,
      member_name: memberName,
      ...totals,
      batting_average: avg,
      on_base_percentage: obp,
      slugging_percentage: slg,
      ops: ops,
    };
  };

  const calculateMemberPitchingTotals = (
    memberId: string,
    memberName: string,
    data: any[]
  ): MemberPitchingStats => {
    const totals = data.reduce(
      (acc, game) => ({
        games: acc.games + 1,
        innings_pitched: acc.innings_pitched + (game.innings_pitched || 0),
        hits_allowed: acc.hits_allowed + (game.hits_allowed || 0),
        runs_allowed: acc.runs_allowed + (game.runs_allowed || 0),
        earned_runs: acc.earned_runs + (game.earned_runs || 0),
        strikeouts: acc.strikeouts + (game.strikeouts || 0),
        walks: acc.walks + (game.walks || 0),
        home_runs_allowed:
          acc.home_runs_allowed + (game.home_runs_allowed || 0),
        wins: acc.wins + (game.win ? 1 : 0),
        losses: acc.losses + (game.loss ? 1 : 0),
        saves: acc.saves + (game.save ? 1 : 0),
      }),
      {
        games: 0,
        innings_pitched: 0,
        hits_allowed: 0,
        runs_allowed: 0,
        earned_runs: 0,
        strikeouts: 0,
        walks: 0,
        home_runs_allowed: 0,
        wins: 0,
        losses: 0,
        saves: 0,
      }
    );

    const decisions = totals.wins + totals.losses;
    const winPercentage =
      decisions > 0 ? ((totals.wins / decisions) * 100).toFixed(1) : "0.0";

    const actualInnings =
      Math.floor(totals.innings_pitched) +
      ((totals.innings_pitched % 1) * 10) / 3;

    const inningsDisplay = formatInnings(totals.innings_pitched);

    const era =
      actualInnings > 0
        ? ((totals.earned_runs * 7) / actualInnings).toFixed(2)
        : "0.00";

    const whip =
      actualInnings > 0
        ? ((totals.walks + totals.hits_allowed) / actualInnings).toFixed(2)
        : "0.00";

    const kPerNine =
      actualInnings > 0
        ? ((totals.strikeouts * 7) / actualInnings).toFixed(2)
        : "0.00";

    const bbPerNine =
      actualInnings > 0
        ? ((totals.walks * 7) / actualInnings).toFixed(2)
        : "0.00";

    return {
      member_id: memberId,
      member_name: memberName,
      ...totals,
      innings_display: inningsDisplay,
      era: era,
      whip: whip,
      k_per_nine: kPerNine,
      bb_per_nine: bbPerNine,
    };
  };

  const formatInnings = (innings: number): string => {
    const wholeInnings = Math.floor(innings);
    const outs = Math.round((innings % 1) * 10);

    if (outs === 0) return `${wholeInnings}.0`;
    if (outs === 1) return `${wholeInnings}.1`;
    if (outs === 2) return `${wholeInnings}.2`;
    return `${wholeInnings}.0`;
  };

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortDirection(sortDirection === "asc" ? "desc" : "asc");
    } else {
      setSortField(field);
      setSortDirection("desc");
    }
  };

  const sortStats = (stats: any[], field: string) => {
    return [...stats].sort((a, b) => {
      let aVal = a[field];
      let bVal = b[field];

      if (typeof aVal === "string" && aVal.startsWith(".")) {
        aVal = parseFloat(aVal);
        bVal = parseFloat(bVal);
      }

      if (sortDirection === "asc") {
        return aVal > bVal ? 1 : -1;
      } else {
        return aVal < bVal ? 1 : -1;
      }
    });
  };

  if (loading) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div className="space-y-3">
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded"></div>
          </div>
        </div>
      </div>
    );
  }

  if (battingStats.length === 0 && pitchingStats.length === 0) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <h3 className="text-lg font-semibold text-gray-900 mb-4">ãƒãƒ¼ãƒ æˆç¸¾</h3>
        <p className="text-gray-500 text-center py-8">
          ã¾ã æˆç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
        </p>
      </div>
    );
  }

  const sortedBattingStats = sortStats(battingStats, sortField);
  const sortedPitchingStats = sortStats(pitchingStats, sortField);

  return (
    <div className="bg-white rounded-lg shadow">
      <div className="px-6 py-4 border-b">
        <h3 className="text-lg font-semibold text-gray-900">ãƒãƒ¼ãƒ æˆç¸¾</h3>
      </div>

      {}
      <div className="border-b">
        <div className="flex">
          <button
            onClick={() => {
              setActiveTab("batting");
              setSortField("batting_average");
              setSortDirection("desc");
            }}
            className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
              activeTab === "batting"
                ? "text-blue-600 border-blue-600"
                : "text-gray-500 border-transparent hover:text-gray-700"
            }`}
          >
            æ‰“æ’ƒæˆç¸¾ ({battingStats.length}å)
          </button>
          <button
            onClick={() => {
              setActiveTab("pitching");
              setSortField("era");
              setSortDirection("asc");
            }}
            className={`px-6 py-3 text-sm font-medium border-b-2 transition-colors ${
              activeTab === "pitching"
                ? "text-blue-600 border-blue-600"
                : "text-gray-500 border-transparent hover:text-gray-700"
            }`}
          >
            æŠ•æ‰‹æˆç¸¾ ({pitchingStats.length}å)
          </button>
        </div>
      </div>

      {}
      <div className="overflow-x-auto">
        {activeTab === "batting" && battingStats.length > 0 && (
          <table className="min-w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  é¸æ‰‹å
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("games")}
                >
                  è©¦åˆ
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("batting_average")}
                >
                  æ‰“ç‡{" "}
                  {sortField === "batting_average" &&
                    (sortDirection === "desc" ? "â†“" : "â†‘")}
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("home_runs")}
                >
                  æœ¬å¡æ‰“
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("rbi")}
                >
                  æ‰“ç‚¹
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("ops")}
                >
                  OPS
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  æ‰“æ•°
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å®‰æ‰“
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  äºŒå¡æ‰“
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ä¸‰å¡æ‰“
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å¾—ç‚¹
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å››çƒ
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ç›—å¡
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å‡ºå¡ç‡
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  é•·æ‰“ç‡
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {sortedBattingStats.map((stats, index) => (
                <tr
                  key={stats.member_id}
                  className={index % 2 === 0 ? "bg-white" : "bg-gray-50"}
                >
                  <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    {stats.member_name}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.games}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                    {stats.batting_average}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.home_runs}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.rbi}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                    {stats.ops}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.at_bats}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.hits}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.doubles}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.triples}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.runs}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.walks}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.stolen_bases}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.on_base_percentage}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.slugging_percentage}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}

        {activeTab === "pitching" && pitchingStats.length > 0 && (
          <table className="min-w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  é¸æ‰‹å
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("games")}
                >
                  ç™»æ¿
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("era")}
                >
                  é˜²å¾¡ç‡{" "}
                  {sortField === "era" && (sortDirection === "asc" ? "â†‘" : "â†“")}
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("innings_pitched")}
                >
                  æŠ•çƒå›
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("strikeouts")}
                >
                  å¥ªä¸‰æŒ¯
                </th>
                <th
                  className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort("whip")}
                >
                  WHIP
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  è¢«å®‰æ‰“
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å¤±ç‚¹
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  è‡ªè²¬ç‚¹
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ä¸å››çƒ
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  è¢«æœ¬å¡æ‰“
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  K/7
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  BB/7
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å‹æ•—
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ã‚»ãƒ¼ãƒ–
                </th>
                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  å‹ç‡
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {sortedPitchingStats.map((stats, index) => (
                <tr
                  key={stats.member_id}
                  className={index % 2 === 0 ? "bg-white" : "bg-gray-50"}
                >
                  <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    {stats.member_name}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.games}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                    {stats.era}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.innings_display}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.strikeouts}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                    {stats.whip}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.hits_allowed}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.runs_allowed}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.earned_runs}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.walks}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.home_runs_allowed}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.k_per_nine}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.bb_per_nine}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.wins}-{stats.losses}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">
                    {stats.saves}
                  </td>
                  <td className="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold text-gray-900">
                    {stats.win_percentage}%
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}


================================================================================
FILE: src/components/stats/TeamOperationStats.tsx
================================================================================

"use client";

import { useState, useEffect } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

interface TaskStat {
  person_name: string;
  task_type: string;
  count: number;
}

interface PersonStat {
  person_name: string;
  total_tasks: number;
  tasks_breakdown: {
    task_type: string;
    count: number;
  }[];
}

interface TeamOperationStatsProps {
  teamId: string;
}

const TASK_LABELS: { [key: string]: { label: string; icon: string } } = {
  equipment: { label: "ç”¨å…·ã®ä¿ç®¡ãƒ»é‹æ¬", icon: "ğŸ’" },
  scheduling: { label: "è©¦åˆã‚’çµ„ã‚€", icon: "ğŸ“…" },
  coordination: { label: "å¯¾æˆ¦ç›¸æ‰‹ã¨ã®èª¿æ•´", icon: "ğŸ¤" },
  ground: { label: "ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ç”¨æ„", icon: "ğŸŸï¸" },
  attendance: { label: "å‡ºæ¬ ã‚’å–ã‚‹", icon: "ğŸ“‹" },
  umpire: { label: "å¯©åˆ¤ã®æ‰‹é…", icon: "âš¾" },
  helper: { label: "åŠ©ã£äººã®æ‰‹é…", icon: "ğŸ‘¥" },
  media: { label: "å†™çœŸãƒ»å‹•ç”»æ’®å½±", icon: "ğŸ“¸" },
  accounting: { label: "ä¼šè¨ˆå ±å‘Š", icon: "ğŸ’°" },
};

export default function TeamOperationStats({
  teamId,
}: TeamOperationStatsProps) {
  const [personStats, setPersonStats] = useState<PersonStat[]>([]);
  const [taskStats, setTaskStats] = useState<{ [key: string]: number }>({});
  const [loading, setLoading] = useState(true);
  const [year] = useState(new Date().getFullYear());
  const [totalGames, setTotalGames] = useState(0);
  const [activeView, setActiveView] = useState<"person" | "task">("person");
  const supabase = createClientComponentClient();

  useEffect(() => {
    if (teamId) {
      fetchOperationStats();
    }
  }, [teamId]);

  const fetchOperationStats = async () => {
    try {

      const startOfYear = `${year}-01-01`;
      const endOfYear = `${year}-12-31`;

      const { data: gamesData, error: gamesError } = await supabase
        .from("games")
        .select("id")
        .eq("home_team_id", teamId)
        .gte("game_date", startOfYear)
        .lte("game_date", endOfYear);

      if (gamesError) {
        console.error("è©¦åˆå–å¾—ã‚¨ãƒ©ãƒ¼:", gamesError);
        setLoading(false);
        return;
      }

      if (!gamesData || gamesData.length === 0) {
        setLoading(false);
        return;
      }

      setTotalGames(gamesData.length);
      const gameIds = gamesData.map((g) => g.id);

      const { data: tasksData, error: tasksError } = await supabase
        .from("game_operation_tasks")
        .select("*")
        .in("game_id", gameIds);

      if (tasksError) {
        console.error("ã‚¿ã‚¹ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", tasksError);
        setLoading(false);
        return;
      }

      if (!tasksData || tasksData.length === 0) {
        setLoading(false);
        return;
      }

      const personMap = new Map<
        string,
        {
          total: number;
          tasks: Map<string, number>;
        }
      >();

      const taskCount: { [key: string]: number } = {};

      tasksData.forEach((task) => {

        const existing = personMap.get(task.person_name) || {
          total: 0,
          tasks: new Map<string, number>(),
        };
        existing.total++;
        existing.tasks.set(
          task.task_type,
          (existing.tasks.get(task.task_type) || 0) + 1
        );
        personMap.set(task.person_name, existing);

        taskCount[task.task_type] = (taskCount[task.task_type] || 0) + 1;
      });

      const stats: PersonStat[] = Array.from(personMap.entries()).map(
        ([name, data]) => ({
          person_name: name,
          total_tasks: data.total,
          tasks_breakdown: Array.from(data.tasks.entries())
            .map(([type, count]) => ({
              task_type: type,
              count: count,
            }))
            .sort((a, b) => b.count - a.count),
        })
      );

      stats.sort((a, b) => b.total_tasks - a.total_tasks);

      setPersonStats(stats);
      setTaskStats(taskCount);
    } catch (error) {
      console.error("é›†è¨ˆã‚¨ãƒ©ãƒ¼:", error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="bg-white rounded-lg shadow p-6">
        <div className="animate-pulse">
          <div className="h-4 bg-gray-200 rounded w-1/4 mb-4"></div>
          <div className="space-y-3">
            <div className="h-3 bg-gray-200 rounded"></div>
            <div className="h-3 bg-gray-200 rounded"></div>
          </div>
        </div>
      </div>
    );
  }

  if (personStats.length === 0) {
    return null;
  }

  const topContributors = personStats.slice(0, 3);

  return (
    <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg shadow-lg border border-orange-200">
      <div className="px-6 py-4 border-b border-orange-200 bg-white bg-opacity-70 rounded-t-lg">
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-semibold text-gray-900 flex items-center">
            <span className="text-2xl mr-2">ğŸ†</span>
            {year}å¹´ ãƒãƒ¼ãƒ é‹å–¶ã¸ã®è²¢çŒ®
          </h3>
          <span className="text-sm text-gray-600">
            {totalGames}è©¦åˆåˆ†ã®é›†è¨ˆ
          </span>
        </div>
      </div>

      {}
      <div className="text-center mt-6 p-4 bg-white bg-opacity-80 rounded-lg">
        <p className="text-lg font-bold text-orange-800">
          âœ¨ ãƒãƒ¼ãƒ é‹å–¶ã«ã”å”åŠ›ã„ãŸã ãã€æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ âœ¨
        </p>
      </div>

      <div className="p-6">
        {activeView === "person" ? (
          <>
            {}
            <div className="mb-6">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {topContributors.map((person, index) => {
                  const medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : "ğŸ¥‰";
                  const bgColor =
                    index === 0
                      ? "bg-yellow-100"
                      : index === 1
                      ? "bg-gray-100"
                      : "bg-orange-100";

                  return (
                    <div
                      key={person.person_name}
                      className={`${bgColor} rounded-lg p-4 text-center shadow-sm`}
                    >
                      <div className="text-3xl mb-2">{medal}</div>
                      <h4 className="font-bold text-gray-900 text-lg mb-1">
                        {person.person_name}
                      </h4>
                      <p className="text-2xl font-bold text-gray-800 mb-2">
                        {person.total_tasks}å›
                      </p>
                      <div className="text-xs text-gray-600 space-y-1">
                        {person.tasks_breakdown.slice(0, 2).map((task) => {
                          const taskInfo = TASK_LABELS[task.task_type];
                          return (
                            <div key={task.task_type}>
                              {taskInfo?.icon} {taskInfo?.label}: {task.count}å›
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {}
            <div className="bg-white rounded-lg p-4">
              <h4 className="font-semibold text-gray-900 mb-3">å…¨è²¢çŒ®è€…ä¸€è¦§</h4>
              <div className="space-y-3">
                {personStats.map((person, index) => (
                  <div
                    key={person.person_name}
                    className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors"
                  >
                    <div className="flex items-center">
                      <span className="text-lg font-semibold text-gray-500 w-8">
                        {index + 1}
                      </span>
                      <span className="font-medium text-gray-900 ml-3">
                        {person.person_name}
                      </span>
                    </div>
                    <div className="flex items-center space-x-4">
                      <div className="text-right">
                        <span className="text-xl font-bold text-orange-600">
                          {person.total_tasks}
                        </span>
                        <span className="text-sm text-gray-500 ml-1">å›</span>
                      </div>
                      <details className="cursor-pointer">
                        <summary className="text-sm text-blue-600 hover:text-blue-700">
                          è©³ç´°
                        </summary>
                        <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg p-3 z-10">
                          <div className="space-y-1">
                            {person.tasks_breakdown.map((task) => {
                              const taskInfo = TASK_LABELS[task.task_type];
                              return (
                                <div
                                  key={task.task_type}
                                  className="flex justify-between text-sm"
                                >
                                  <span className="text-gray-600">
                                    {taskInfo?.icon} {taskInfo?.label}
                                  </span>
                                  <span className="font-medium">
                                    {task.count}å›
                                  </span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </details>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </>
        ) : (

          <div className="bg-white rounded-lg p-4">
            <h4 className="font-semibold text-gray-900 mb-3">
              ã‚¿ã‚¹ã‚¯åˆ¥å®Ÿæ–½å›æ•°
            </h4>
            <div className="space-y-4">
              {Object.entries(TASK_LABELS).map(([taskType, taskInfo]) => {
                const count = taskStats[taskType] || 0;
                const percentage =
                  totalGames > 0 ? Math.round((count / totalGames) * 100) : 0;

                return (
                  <div key={taskType} className="border-b pb-3 last:border-b-0">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center">
                        <span className="text-2xl mr-3">{taskInfo.icon}</span>
                        <span className="font-medium text-gray-900">
                          {taskInfo.label}
                        </span>
                      </div>
                      <div className="text-right">
                        <span className="text-lg font-bold text-gray-800">
                          {count}
                        </span>
                        <span className="text-sm text-gray-500 ml-1">
                          / {totalGames}è©¦åˆ
                        </span>
                      </div>
                    </div>
                    <div className="ml-11">
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                          className="bg-orange-500 h-2 rounded-full transition-all duration-500"
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                      <p className="text-xs text-gray-500 mt-1">
                        {percentage}%ã®è©¦åˆã§å®Ÿæ–½
                      </p>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


