# プロジェクト進捗状況

最終更新: 2025-08-22 16:30

## 実装済み機能

### 基本機能

- [x] ユーザー認証（Google OAuth）
- [x] チーム管理（作成・編集・削除）
- [x] チーム参加申請システム
- [x] 試合管理（作成・編集・削除）
- [x] スコア入力（イニング毎）
- [x] メンバー管理（打順・守備位置設定）
- [x] デフォルトラインナップ機能

### 試合カテゴリー機能（2025-08-22 実装）

- [x] データベースにcategoryカラム追加（'official', 'practice', 'scrimmage'）
- [x] 試合作成ページにカテゴリー選択機能追加
- [x] 試合編集ページにカテゴリー選択機能追加
  - 先攻/後攻選択機能も同時に追加
- [x] 試合詳細ページにカテゴリーバッジ表示
- [x] 試合一覧ページ（/games）にカテゴリーバッジ表示

### 試合進行管理システム

- [x] 打撃成績入力機能
  - 日本語での結果保存（安打、二塁打、三塁打など）
  - 打率・出塁率・長打率の自動計算
  - 到達塁選択機能（2025-08-20 追加）
- [x] ランナー管理機能（2025-08-20 実装）
  - ダイヤモンド型 UI での塁上ランナー表示
  - 出塁時の到達塁選択（エラー絡みの進塁対応）
  - 塁上からの盗塁・得点記録
  - 進塁ボタンと盗塁ボタンの区別
  - イニング交代時の自動クリア
  - リアルタイム更新機能
- [x] **ダブルプレー・トリプルプレー対応（2025-08-20 修正）**
  - 併殺・三重殺時の正確なアウトカウント計算
  - 3 アウト時の自動イニング交代
  - イニングタブの手動選択機能との両立
- [x] 選手交代機能
- [x] 投手成績入力機能（2025-08-17 実装）
  - 全選手から投手選択可能
  - 野球独自の投球回表記（0.1=1 アウト、0.2=2 アウト、3 アウトで 1.0）
  - 防御率・WHIP・K/9・BB/9 の自動計算
- [x] 成績自動集計・表示機能（試合単位）
- [x] 3 アウトで自動イニング交代
- [x] 自チーム攻撃回のみ詳細入力
- [x] 7 回制対応

### 成績表示機能（2025-08-18 実装）

- [x] ユーザーダッシュボードに個人の通算成績表示
  - 打撃成績：打率、本塁打、打点、OPS 等
  - 投手成績：防御率、奪三振、WHIP、K/7、BB/7 等
- [x] チーム詳細ページにメンバーの成績一覧表示
  - 全メンバーの打撃成績ランキング
  - 全メンバーの投手成績ランキング
  - ソート機能付きテーブル表示

### 運営タスク管理機能（2025-08-18 実装）

- [x] 試合ごとの運営タスク登録
  - 用具管理、試合調整、グラウンド手配など 9 種類のタスク
  - チームメンバーから選択またはテキスト入力で担当者登録
- [x] 試合詳細ページでの貢献者表示
  - 感謝のメッセージ付き表示
- [x] チーム詳細ページでの年間貢献度集計
  - 貢献者ランキング（MVP 表彰）
  - タスク別実施率の可視化

### 出欠確認機能（2025-08-18 実装）

- [x] データベース設計（game_attendances テーブル、RLS ポリシー）
- [x] games テーブルに attendance_check_enabled 列追加
- [x] 試合作成ページに出欠確認設定追加
- [x] 試合詳細ページに出欠確認 UI 追加
  - 出欠確認セクションの表示
  - メンバーごとの「出席」「欠席」ボタン
  - ゲスト（助っ人）追加機能

### 認証リダイレクト問題の修正（2025-08-20 完了）

- [x] 全ページで authLoading チェックを追加して不要なリダイレクトを防止
  - /games/[gameId]/progress/page.tsx
  - /games/[gameId]/page.tsx
  - /games/[gameId]/players/page.tsx
  - /games/[gameId]/edit/page.tsx
  - /games/[gameId]/score/page.tsx
  - /games/[gameId]/operations/page.tsx

### UI/UX 改善（2025-08-18 実装）

- [x] インラインスコア入力
  - 試合詳細ページ内で直接スコア編集可能
  - ページ遷移不要のスムーズな操作

### パフォーマンス最適化（2025-08-18 実装）

- [x] StatsDisplay.tsx のハイブリッドアプローチ実装
  - 試合終了後：データベースビューから取得（高速）
  - 試合進行中：クライアントサイドでリアルタイム計算
  - 試合ステータスによる自動切り替え

### データベース

- [x] player_batting_stats: 打撃成績集計ビュー
- [x] player_pitching_stats: 投手成績集計ビュー
- [x] game_operation_tasks: 運営タスク管理テーブル
- [x] game_attendances: 出欠確認テーブル
- [x] game_runners: ランナー管理テーブル（2025-08-20 追加）
- [x] game_batting_records: 到達塁・盗塁詳細列追加（2025-08-20 更新）
  - base_reached: 到達塁情報
  - stolen_bases_detail: 盗塁詳細（JSON 形式）
- [x] games: categoryカラム追加（2025-08-22 追加）

## 現在の不具合

なし

## 次回実装予定

### 1. 試合検索ページの機能拡張（優先度：高）

- [ ] `/search/games`にカテゴリーバッジ表示
- [ ] カテゴリーによる絞り込み機能追加
- [ ] 実装対象ファイル：`src/components/search/PublicGameSearch.tsx`
- [ ] 必要な修正内容：
  - Game interfaceにcategory追加
  - フィルター条件にカテゴリー選択追加
  - 一覧表示にカテゴリーバッジ追加

### 2. 出欠確認機能の完成（優先度：高）

- [ ] ダッシュボード（/dashboard/page.tsx）に未回答アラート強化
- [ ] 出席者 9 人以下の場合のアラート強化

### 3. ランナー管理機能の拡張（優先度：中）

- [ ] より現実的な進塁ロジック
- [ ] タッチアップ対応
- [ ] 牽制・暴投による進塁

### 4. 今後の機能検討（優先度：低）

- [ ] マテリアライズドビューの導入検討
- [ ] WebSocket によるリアルタイム更新機能
- [ ] 試合結果の自動集計レポート機能
- [ ] 対戦成績の記録・分析機能

## 技術的な決定事項

### 試合カテゴリー実装（2025-08-22 追加）

1. **データ設計**
   - gamesテーブルにcategoryカラム追加（VARCHAR(20)）
   - 値：'official'（公式戦）、'practice'（練習試合）、'scrimmage'（紅白戦）
   - デフォルト値：'practice'
   - CHECK制約で値を制限

2. **UI設計**
   - カテゴリーごとにバッジの色を変更
     - 公式戦：赤（bg-red-100 text-red-800）
     - 練習試合：青（bg-blue-100 text-blue-800）
     - 紅白戦：緑（bg-green-100 text-green-800）
   - 作成・編集時はセレクトボックスで選択

3. **実装上の注意点**
   - 既存データには影響なし（デフォルト値設定済み）
   - 先攻/後攻機能を削除しないよう注意（スコア入力ページで使用）

### ランナー管理アーキテクチャ（2025-08-20 追加）

1. **データ構造**
   - `game_runners`テーブルで塁上のランナー状態を管理
   - `game_batting_records`に`base_reached`（到達塁）を追加
   - `stolen_bases_detail`で JSON 形式で盗塁詳細を保存

2. **UI 設計**
   - ダイヤモンド型の視覚的な塁表示
   - 各塁のランナーに対する個別アクション（進塁・盗塁・得点）
   - 打撃結果に応じた到達塁選択 UI

3. **進塁ロジック**
   - 単打・四球：強制進塁のみ
   - 二塁打：全ランナー 2 塁進塁
   - 三塁打：全ランナー 3 塁進塁（ホームイン）
   - 本塁打：全ランナーホームイン

### ダブルプレー・トリプルプレー処理（2025-08-20 修正）

1. **アウトカウント計算の改善**
   - `BattingRecordInput`コンポーネントでの併殺・三重殺記録時の正確なアウト数計算
   - `GameProgressPage`の`loadAllInningsData`関数で併殺・三重殺を考慮したアウト数集計

2. **イニング遷移の動作**
   - 3 アウト時の自動イニング交代（`onInningChange`コールバック）
   - 手動でのイニングタブ選択機能との両立
   - `handleInningChange`関数でユーザー操作と自動遷移を区別

### 成績計算のアーキテクチャ

1. **データベースビュー（実装済み）**
   - player_batting_stats: 打撃成績集計
   - player_pitching_stats: 投手成績集計

2. **使い分け方針（実装済み）**
   - PersonalStats, TeamMemberStats → ビュー使用
   - StatsDisplay（試合終了後）→ ビュー使用
   - StatsDisplay（試合進行中）→ クライアント計算

### コード修正指示ルール（2025-08-18 追加）

- 行番号による修正指示は禁止
- 修正箇所は具体的なコードで特定
- 大規模修正時は全文提供を優先

## 技術的な注意点

### ランナー管理（2025-08-20 追加）

- 塁の値：1（一塁）、2（二塁）、3（三塁）、4（ホーム/得点）
- `is_active`フラグでアクティブなランナーを管理
- イニング交代時に全ランナーを非アクティブ化
- 編集・削除時の整合性維持（ランナー記録も同時に更新）
- 重複ランナーの自動検出と削除

### 投球回の特殊な表記

- 野球では投球回を「回.アウト数」で表現
- 0.1 = 1 アウト、0.2 = 2 アウト
- 0.3 は存在せず 1.0 に繰り上がる
- データベースには 0.1 刻みで保存
- 計算時は実際のイニング数に変換：`FLOOR(innings) + (innings % 1) * 10 / 3`

### 打撃記録

- result カラムは日本語値で保存（CHECK 制約あり）
- 打率等の計算はサーバーサイド（ビュー）で実施
- base_reached で到達塁を記録（0:アウト、1-3:各塁、4:ホーム）
- notes カラムで併殺・三重殺情報を記録

### 成績データの関連性

- team_members → game_players → player_batting_stats/player_pitching_stats
- user_profiles と team_members は直接 JOIN できない（別クエリで取得が必要）

### 運営タスク

- タスクタイプは 9 種類（equipment, scheduling, coordination, ground, attendance, umpire, helper, media, accounting）
- 担当者は team_member_id または person_name（テキスト）で管理

### 出欠確認

- attendance_check_enabled フラグで機能の有効/無効を管理
- game_attendances テーブルで各メンバーの回答を管理
- ステータス: pending（未回答）、attending（出席）、absent（欠席）

### 試合カテゴリー（2025-08-22 追加）

- gamesテーブルのcategoryカラムで管理
- 値は'official'（公式戦）、'practice'（練習試合）、'scrimmage'（紅白戦）
- UI上では色分けされたバッジで表示
- 検索・絞り込み機能での利用を想定

## 開発環境

- Next.js 14 (App Router)
- TypeScript
- Supabase (PostgreSQL + Auth)
- Tailwind CSS

## 引き継ぎ事項（次回の会話用）

### 実装済み内容（2025-08-22）

- **試合カテゴリー機能の基本実装完了**
  - データベースにcategoryカラム追加
  - 試合作成・編集ページでカテゴリー選択可能
  - 試合詳細・一覧ページでカテゴリー表示
  - 先攻/後攻選択機能も試合編集ページに追加

### 次回の会話で最初に確認すること

1. **前回の作業内容の確認**
   ```
   前回の会話で試合カテゴリー機能（公式戦/練習試合/紅白戦）を実装しました：
   - DBにcategoryカラム追加済み
   - 試合作成・編集・詳細・一覧ページに実装済み
   - 今回は試合検索ページ(/search/games)への実装を行います
   ```

2. **project_knowledge_searchで必要なファイルを確認**
   ```
   検索キーワード: "PublicGameSearch interface Game"
   対象ファイル: src/components/search/PublicGameSearch.tsx
   ```

3. **実装内容の明確化**
   ```
   【必須】作業前確認
   - 要求内容：試合検索ページにカテゴリーバッジ表示と絞り込み機能追加
   - 作業種別：既存機能の修正
   - 対象ファイル：src/components/search/PublicGameSearch.tsx
   - 既存機能：キーワード検索、ステータス絞り込み、日付範囲指定
   - 追加機能：カテゴリーバッジ表示、カテゴリー絞り込み
   ```

### 次回実装内容（優先順）

1. **試合検索ページのカテゴリー対応（最優先）**
   - PublicGameSearch.tsxの修正
   - フィルター機能の追加
   - バッジ表示の実装

2. **出欠確認機能の完成**
   - ダッシュボードの未回答アラート強化
   - 9人以下警告の実装

3. **ランナー管理の高度化**
   - より現実的な進塁ロジック
   - 特殊プレー対応

### 技術的な留意点

- 既存機能を壊さないよう慎重に実装
- complete_source.txt を必ず確認してから修正提案
- 試合カテゴリーのデフォルト値は'practice'
- バッジの色分けは他ページと統一（赤：公式戦、青：練習試合、緑：紅白戦）