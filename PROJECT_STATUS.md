# プロジェクト進捗状況

最終更新: 2025-09-03 12:30

## 実装済み機能

### 基本機能

- [x] ユーザー認証（Google OAuth）
- [x] チーム管理（作成・編集・削除）
- [x] チーム参加申請システム
- [x] 試合管理（作成・編集・削除）
- [x] スコア入力（イニング毎）
- [x] メンバー管理（打順・守備位置設定）
- [x] デフォルトラインナップ機能

### 試合カテゴリー機能（2025-08-22 実装、2025-08-25 完成）

- [x] データベースに category カラム追加（'official', 'practice', 'scrimmage'）
- [x] 試合作成ページにカテゴリー選択機能追加
- [x] 試合編集ページにカテゴリー選択機能追加
  - 先攻/後攻選択機能も同時に追加
- [x] 試合詳細ページにカテゴリーバッジ表示
- [x] 試合一覧ページ（/games）にカテゴリーバッジ表示
- [x] **試合検索ページ（/search/games）にカテゴリー対応（2025-08-25 完了）**
  - カテゴリーバッジ表示
  - カテゴリーによる絞り込み機能

### 試合進行管理システム

- [x] 打撃成績入力機能
  - 日本語での結果保存（安打、二塁打、三塁打など）
  - 打率・出塁率・長打率の自動計算
  - 到達塁選択機能（2025-08-20 追加）
- [x] ランナー管理機能（2025-08-20 実装）
  - ダイヤモンド型 UI での塁上ランナー表示
  - 出塁時の到達塁選択（エラー絡みの進塁対応）
  - 塁上からの盗塁・得点記録
  - 進塁ボタンと盗塁ボタンの区別
  - イニング交代時の自動クリア
  - リアルタイム更新機能
- [x] **ダブルプレー・トリプルプレー対応（2025-08-20 修正）**
  - 併殺・三重殺時の正確なアウトカウント計算
  - 3 アウト時の自動イニング交代
  - イニングタブの手動選択機能との両立
- [x] 選手交代機能
- [x] **投手成績入力機能（2025-08-17 実装、2025-09-03 勝敗・セーブ機能復活）**
  - 全選手から投手選択可能
  - 野球独自の投球回表記（0.1=1 アウト、0.2=2 アウト、3 アウトで 1.0）
  - 防御率・WHIP・K/9・BB/9 の自動計算
  - **勝敗・セーブ登録機能（2025-09-03 復活）**
    - ラジオボタンによる選択 UI（勝/負/セーブ/－）
    - 既存記録表示での勝敗・セーブ表示
    - データベース連携（win, loss, save カラム活用）
- [x] 成績自動集計・表示機能（試合単位）
- [x] 3 アウトで自動イニング交代
- [x] 自チーム攻撃回のみ詳細入力
- [x] 7 回制対応

### 成績表示機能（2025-08-18 実装）

- [x] ユーザーダッシュボードに個人の通算成績表示
  - 打撃成績：打率、本塁打、打点、OPS 等
  - 投手成績：防御率、奪三振、WHIP、K/7、BB/7 等
- [x] チーム詳細ページにメンバーの成績一覧表示
  - 全メンバーの打撃成績ランキング
  - 全メンバーの投手成績ランキング
  - ソート機能付きテーブル表示

### 運営タスク管理機能（2025-08-18 実装）

- [x] 試合ごとの運営タスク登録
  - 用具管理、試合調整、グラウンド手配など 9 種類のタスク
  - チームメンバーから選択またはテキスト入力で担当者登録
- [x] 試合詳細ページでの貢献者表示
  - 感謝のメッセージ付き表示
- [x] チーム詳細ページでの年間貢献度集計
  - 貢献者ランキング（MVP 表彰）
  - タスク別実施率の可視化

### 出欠確認機能（2025-08-18 実装）

- [x] データベース設計（game_attendances テーブル、RLS ポリシー）
- [x] games テーブルに attendance_check_enabled 列追加
- [x] 試合作成ページに出欠確認設定追加
- [x] 試合詳細ページに出欠確認 UI 追加
  - 出欠確認セクションの表示
  - メンバーごとの「出席」「欠席」ボタン
  - ゲスト（助っ人）追加機能

### 認証リダイレクト問題の修正（2025-08-20 完了）

- [x] 全ページで authLoading チェックを追加して不要なリダイレクトを防止
  - /games/[gameId]/progress/page.tsx
  - /games/[gameId]/page.tsx
  - /games/[gameId]/players/page.tsx
  - /games/[gameId]/edit/page.tsx
  - /games/[gameId]/score/page.tsx
  - /games/[gameId]/operations/page.tsx

### UI/UX 改善（2025-08-18 実装）

- [x] インラインスコア入力
  - 試合詳細ページ内で直接スコア編集可能
  - ページ遷移不要のスムーズな操作

### パフォーマンス最適化（2025-08-18 ～ 2025-08-25）

- [x] StatsDisplay.tsx のハイブリッドアプローチ実装
  - 試合終了後：データベースビューから取得（高速）
  - 試合進行中：クライアントサイドでリアルタイム計算
  - 試合ステータスによる自動切り替え
- [x] **プロジェクトナレッジの軽量化（2025-08-25 完了）**
  - ルール文書を 87%削減（15,000 文字 →2,000 文字）
  - complete_source.txt を 6 ファイルに分割
  - database_schema_lite.txt 導入（30,000 文字 →2,000 文字）
  - 不要ファイルの削除（95%削減達成）

### データベース

- [x] player_batting_stats: 打撃成績集計ビュー
- [x] player_pitching_stats: 投手成績集計ビュー
- [x] game_operation_tasks: 運営タスク管理テーブル
- [x] game_attendances: 出欠確認テーブル
- [x] game_runners: ランナー管理テーブル（2025-08-20 追加）
- [x] game_batting_records: 到達塁・盗塁詳細列追加（2025-08-20 更新）
  - base_reached: 到達塁
  - stolen_bases_detail: 盗塁詳細（JSON 形式）
- [x] games: category カラム追加（2025-08-22 追加）
- [x] **database_schema_lite.txt 導入（2025-08-25 追加）**
  - 軽量版 DB 構造（自動生成 SQL 使用）
- [x] **game_pitching_records: 勝敗・セーブカラム活用（2025-09-03 確認・復活）**
  - win: 勝利投手フラグ
  - loss: 敗戦投手フラグ
  - save: セーブ投手フラグ

## 現在の進行状況

### 投手成績記録システム強化（2025-09-02〜03 完了）

**背景**: 以前のエラー対応で勝敗・セーブ機能が削除されていたが、実際はデータベースにカラムが存在

- [x] **フェーズ 1: 問題分析（2025-09-02 完了）**

  - データベーススキーマ確認（win, loss, save カラム存在確認）
  - PitchingRecordInput コンポーネントの現状調査
  - 前回削除された機能の特定

- [x] **フェーズ 2: 勝敗・セーブ機能復活（2025-09-03 完了）**
  - PitchingRecord インターフェースの拡張
  - 初期データ構造の更新（win, loss, save フィールド追加）
  - ラジオボタンによる勝敗・セーブ選択 UI 実装
  - 既存記録表示での勝敗・セーブ表示強化（色付きバッジ表示）
  - handleEdit, handleSave 関数の勝敗・セーブ対応

### 試合スコアボックス統合編集機能（2025-08-26 実装中）

- [x] **フェーズ 1: 基盤実装（完了）**

  - ScoreBoxDisplay 守備位置セレクトボックス化
  - 打撃結果セレクトボックス化
  - 詳細入力モード切替機能
  - game-logic.ts 作成（共通ロジック抽出）
    - advanceRunners（ランナー進塁）
    - calculateBaseReached（到達塁計算）
    - isOutResult（アウト判定）

- [ ] **フェーズ 2: 統合実装（進行中）**

  - BattingInputModal コンポーネント作成
  - saveBattingWithIntegrity 実装
  - データ整合性維持機能
  - ランナー管理連動

- [ ] **フェーズ 3: 完成（予定）**
  - 併殺処理連動
  - 得点・打点自動計算
  - リアルタイム更新
  - GameProgressPage との互換性維持

## 次回実装予定

### 統計・分析機能の強化（優先度：高）

- [ ] **投手成績統計の拡張**

  - 勝敗・セーブを含む統計表示の更新
  - PersonalStats.tsx での勝敗・セーブ表示
  - TeamMemberStats.tsx での勝率計算表示
  - 勝率ランキング機能

- [ ] **試合進行管理画面での勝敗判定支援**
  - 試合終了時の勝利投手・敗戦投手・セーブ投手の自動判定提案
  - 投球回・失点状況に基づく判定ロジック

### 出欠確認機能の完成（優先度：中）

- [ ] ダッシュボードでのアラート強化
- [ ] 9 人以下警告
- [ ] 締切日時設定

### 今後の機能検討（優先度：低）

- [ ] マテリアライズドビューの導入検討
- [ ] WebSocket によるリアルタイム更新機能
- [ ] 試合結果の自動集計レポート機能
- [ ] SNS 共有機能（試合結果のシェア）
- [ ] PWA 対応（オフライン対応）

## 技術的な決定事項

### プロジェクトナレッジ構成（2025-08-25 最適化完了）

1. **ファイル構成**

   - 絶対に守るべきルール（改善版）.md - 開発ルール
   - PROJECT_STATUS.md - プロジェクト状況
   - database_schema_lite.txt - 軽量 DB 構造
   - create-split-source-files.js - ソース分割スクリプト
   - source_files_summary.txt - ファイル一覧

2. **ソースコード管理**
   - Node.js スクリプトで 6 ファイルに自動分割
   - 必要時に再生成可能
   - プロジェクトナレッジには含めない（軽量化のため）

### 試合カテゴリー実装（2025-08-22 ～ 25 完了）

1. **データ設計**

   - games テーブルに category カラム追加（VARCHAR(20)）
   - 値：'official'（公式戦）、'practice'（練習試合）、'scrimmage'（紅白戦）
   - デフォルト値：'practice'
   - CHECK 制約で値を制限

2. **UI 設計**
   - カテゴリーごとにバッジの色を変更
     - 公式戦：赤（bg-red-100 text-red-800）
     - 練習試合：青（bg-blue-100 text-blue-800）
     - 紅白戦：緑（bg-green-100 text-green-800）
   - 作成・編集時はセレクトボックスで選択
   - 検索ページで絞り込み可能

### ランナー管理アーキテクチャ（2025-08-20 追加）

1. **データ構造**

   - `game_runners`テーブルで塁上のランナー状態を管理
   - `game_batting_records`に`base_reached`（到達塁）を追加
   - `stolen_bases_detail`で JSON 形式で盗塁詳細を保存

2. **UI 設計**

   - ダイヤモンド型の視覚的な塁表示
   - 各塁のランナーに対する個別アクション（進塁・盗塁・得点）
   - 打撃結果に応じた到達塁選択 UI

3. **進塁ロジック**
   - 単打・四球：強制進塁のみ
   - 二塁打：全ランナー 2 塁進塁
   - 三塁打：全ランナー 3 塁進塁（ホームイン）
   - 本塁打：全ランナーホームイン

### ダブルプレー・トリプルプレー処理（2025-08-20 修正）

1. **アウトカウント計算の改善**

   - `BattingRecordInput`コンポーネントでの併殺・三重殺記録時の正確なアウト数計算
   - `GameProgressPage`の`loadAllInningsData`関数で併殺・三重殺を考慮したアウト数集計

2. **イニング遷移の動作**
   - 3 アウト時の自動イニング交代（`onInningChange`コールバック）
   - 手動でのイニングタブ選択機能との両立
   - `handleInningChange`関数でユーザー操作と自動遷移を区別

### 投手成績管理アーキテクチャ（2025-09-03 更新）

1. **データベース設計**

   - `game_pitching_records`テーブルの勝敗・セーブカラム活用
   - win, loss, save: boolean 型（デフォルト false）
   - 同一試合で複数投手の勝敗・セーブ設定可能

2. **UI 設計**
   - ラジオボタンによる排他選択（勝/負/セーブ/－）
   - 既存記録表示での視覚的な勝敗・セーブ表示
   - 色分け：勝（緑）、負（赤）、セーブ（青）

### 成績計算のアーキテクチャ

1. **データベースビュー（実装済み）**

   - player_batting_stats: 打撃成績集計
   - player_pitching_stats: 投手成績集計

2. **使い分け方針（実装済み）**
   - PersonalStats, TeamMemberStats → ビュー使用
   - StatsDisplay（試合終了後）→ ビュー使用
   - StatsDisplay（試合進行中）→ クライアント計算

### コード修正指示ルール（2025-08-18 追加、2025-09-03 強化）

- 行番号による修正指示は禁止
- 修正箇所は具体的なコードで特定
- 既存コードの提示必須
- 大規模修正時は全文提供を優先

## 技術的な注意点

### ランナー管理（2025-08-20 追加）

- 塁の値：1（一塁）、2（二塁）、3（三塁）、4（ホーム/得点）
- `is_active`フラグでアクティブなランナーを管理
- イニング交代時に全ランナーを非アクティブ化
- 編集・削除時の整合性維持（ランナー記録も同時に更新）
- 重複ランナーの自動検出と削除

### 投球回の特殊な表記

- 野球では投球回を「回.アウト数」で表現
- 0.1 = 1 アウト、0.2 = 2 アウト
- 0.3 は存在せず 1.0 に繰り上がる
- データベースには 0.1 刻みで保存
- 計算時は実際のイニング数に変換：`FLOOR(innings) + (innings % 1) * 10 / 3`

### 打撃記録

- result カラムは日本語値で保存（CHECK 制約あり）
- 打率等の計算はサーバーサイド（ビュー）で実施
- base_reached で到達塁を記録（0:アウト、1-3:各塁、4:ホーム）
- notes カラムで併殺・三重殺情報を記録

### 投手成績記録（2025-09-03 更新）

- win, loss, save は boolean 型で排他的選択
- 同一投手が複数試合で異なる結果を持つことが可能
- UI では勝敗・セーブを視覚的に区別（色分け表示）
- データベース保存時は false が明示的に設定される

### 成績データの関連性

- team_members → game_players → player_batting_stats/player_pitching_stats
- user_profiles と team_members は直接 JOIN できない（別クエリで取得が必要）

### 運営タスク

- タスクタイプは 9 種類（equipment, scheduling, coordination, ground, attendance, umpire, helper, media, accounting）
- 担当者は team_member_id または person_name（テキスト）で管理

### 出欠確認

- attendance_check_enabled フラグで機能の有効/無効を管理
- game_attendances テーブルで各メンバーの回答を管理
- ステータス: pending（未回答）、attending（出席）、absent（欠席）

### 試合カテゴリー（2025-08-22 ～ 25 完了）

- games テーブルの category カラムで管理
- 値は'official'（公式戦）、'practice'（練習試合）、'scrimmage'（紅白戦）
- UI 上では色分けされたバッジで表示
- 検索・絞り込み機能での利用を想定
- 全ページ（作成、編集、詳細、一覧、検索）で実装完了

### ScoreBoxDisplay 統合設計（2025-08-26 追加）

- 試合詳細ページで完結する入力システム
- game-logic.ts による共通ロジック管理
- 簡易編集モード（既存）と詳細入力モード（新規）の切替
- game_batting_records、game_runners、games テーブルの整合性自動維持
- GameProgressPage との機能互換性を保持

## 開発環境

- Next.js 14 (App Router)
- TypeScript
- Supabase (PostgreSQL + Auth)
- Tailwind CSS

## 引き継ぎ事項（次回の会話用）

### 最新実装済み内容（2025-09-03）

- **投手成績記録システムの勝敗・セーブ機能復活（完了）**
  - PitchingRecordInput.tsx での勝敗・セーブ入力 UI 実装
  - 既存記録表示での勝敗・セーブ表示強化
  - データベース連携の完全復活

### 次回の会話で最初に確認すること

1. **前回の作業内容の確認**

   ```
   前回の会話で投手成績記録システムの勝敗・セーブ機能を復活させました：
   - PitchingRecordInput.tsx の完全修正
   - ラジオボタンによる勝敗・セーブ選択UI実装
   - 既存記録での勝敗・セーブ表示強化
   ```

2. **create-split-source-files.js でソース生成**

   ```
   必要に応じて以下を実行：
   node create-split-source-files.js
   ```

3. **実装内容の選択**
   ```
   【必須】作業前確認
   - 優先度高：投手成績統計の拡張（勝敗・セーブ表示）
   - 優先度中：出欠確認機能の完成、試合進行管理での勝敗判定支援
   - その他：新機能の検討
   ```

### 次回実装内容（優先順）

1. **投手成績統計の拡張（最優先）**

   - PersonalStats.tsx での勝敗・セーブ表示追加
   - TeamMemberStats.tsx での勝率計算・表示
   - 統計画面での勝敗ランキング機能

2. **試合進行管理での勝敗判定支援**

   - 試合終了時の勝利投手・敗戦投手・セーブ投手の自動判定提案
   - 野球ルールに基づく判定ロジック実装

3. **出欠確認機能の完成**
   - ダッシュボードでのアラート強化
   - 9 人以下警告機能

### 技術的な留意点

- database_schema_lite.txt を活用（軽量版）
- 必要時にソースファイルを再生成
- 既存機能を壊さないよう慎重に実装
- 「絶対に守るべきルール（改善版）」の 3 ステップを遵守
- **投手成績の勝敗・セーブ機能が完全復活済み**のため、統計表示の拡張が次の重要な課題
