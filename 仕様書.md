# 草野球 is Good - アプリケーション仕様書

**最終更新日：2025-08-24**
**バージョン：1.0.0**

## 1. アプリケーション概要

### 1.1 基本情報
- **アプリケーション名**：草野球 is Good
- **用途**：草野球チーム管理Webアプリケーション
- **対象ユーザー**：草野球チームの管理者およびメンバー
- **技術スタック**：
  - フロントエンド：Next.js 14 (App Router), TypeScript, Tailwind CSS
  - バックエンド：Supabase (PostgreSQL + Auth)
  - 認証：Google OAuth

### 1.2 主要機能
1. チーム管理
2. 試合管理
3. スコア入力・管理
4. 選手成績管理
5. 出欠確認
6. 運営タスク管理

## 2. 機能仕様

### 2.1 認証機能

#### 2.1.1 ログイン機能
- **機能ID**：AUTH-001
- **実装状態**：✅ 実装済み
- **機能概要**：Google OAuthによるログイン
- **詳細仕様**：
  - Google認証のみ対応（メール/パスワード認証なし）
  - 初回ログイン時は自動的にユーザープロファイル作成
  - ログイン後、ユーザー名未設定の場合は設定画面へリダイレクト
- **関連ファイル**：
  - `/src/app/login/page.tsx`
  - `/src/contexts/AuthContext.tsx`
- **注意事項**：authLoadingのチェックは必須（削除禁止）

#### 2.1.2 ユーザー名設定
- **機能ID**：AUTH-002
- **実装状態**：✅ 実装済み
- **機能概要**：初回ログイン時のユーザー名設定
- **詳細仕様**：
  - 初回ログイン時に必須
  - 1〜20文字の制限
  - 後からダッシュボードで変更可能
  - 表示優先順位：display_name → username → "名前未設定"
- **関連ファイル**：
  - `/src/app/profile/setup/page.tsx`
  - `/src/app/dashboard/settings/page.tsx`

### 2.2 チーム管理機能

#### 2.2.1 チーム作成
- **機能ID**：TEAM-001
- **実装状態**：✅ 実装済み
- **機能概要**：新規チーム作成
- **詳細仕様**：
  - チーム名（必須、1〜100文字）
  - 説明（任意、最大500文字）
  - 作成者が自動的にオーナーになる
  - 作成者は自動的にチームメンバーになる
- **関連ファイル**：
  - `/src/app/teams/create/page.tsx`

#### 2.2.2 チーム編集
- **機能ID**：TEAM-002
- **実装状態**：✅ 実装済み
- **機能概要**：チーム情報の編集
- **詳細仕様**：
  - オーナーのみ編集可能
  - チーム名、説明を変更可能
  - オーナー権限の譲渡機能
- **関連ファイル**：
  - `/src/app/teams/[teamId]/edit/page.tsx`

#### 2.2.3 チーム参加申請システム
- **機能ID**：TEAM-003
- **実装状態**：✅ 実装済み
- **機能概要**：チームへの参加申請と承認
- **詳細仕様**：
  - 非メンバーは参加申請ボタンを表示
  - オーナーに申請通知
  - オーナーは承認/拒否可能
  - 承認後、自動的にteam_membersに追加
- **関連ファイル**：
  - `/src/app/teams/[teamId]/page.tsx`
- **データベース**：
  - `join_requests`テーブル使用

#### 2.2.4 チームメンバー管理
- **機能ID**：TEAM-004
- **実装状態**：✅ 実装済み
- **機能概要**：チームメンバーの管理
- **詳細仕様**：
  - メンバー一覧表示
  - オーナーはメンバーを削除可能
  - メンバーの役割表示（オーナー/メンバー）
- **関連ファイル**：
  - `/src/app/teams/[teamId]/page.tsx`
- **重要な制約**：
  - team_membersのuser_idはauth.usersを参照（user_profilesではない）
  - user_profilesとteam_membersは別クエリで取得必須

### 2.3 試合管理機能

#### 2.3.1 試合作成
- **機能ID**：GAME-001
- **実装状態**：✅ 実装済み
- **機能概要**：新規試合作成
- **詳細仕様**：
  - 基本情報：
    - 試合名（必須）
    - 日時（必須）
    - 場所（必須）
    - 対戦相手（必須）
    - カテゴリー（公式戦/練習試合/紅白戦）
  - 追加設定：
    - 公開/非公開設定
    - 出欠確認有効/無効
    - 先攻/後攻選択
  - デフォルトラインナップ自動適用
- **関連ファイル**：
  - `/src/app/games/create/page.tsx`

#### 2.3.2 試合編集
- **機能ID**：GAME-002
- **実装状態**：✅ 実装済み
- **機能概要**：試合情報の編集
- **詳細仕様**：
  - チームメンバーのみ編集可能
  - すべての基本情報を編集可能
  - 出欠確認の後からの有効化対応
  - 先攻/後攻の変更可能
- **関連ファイル**：
  - `/src/app/games/[gameId]/edit/page.tsx`
- **注意事項**：
  - 出欠確認を新規有効化した場合、既存メンバーのstatusは'pending'で初期化

#### 2.3.3 試合カテゴリー機能
- **機能ID**：GAME-003
- **実装状態**：✅ 実装済み（試合検索ページは未実装）
- **機能概要**：試合のカテゴリー分類
- **詳細仕様**：
  - カテゴリー種別：
    - official（公式戦）- 赤バッジ
    - practice（練習試合）- 青バッジ
    - scrimmage（紅白戦）- 緑バッジ
  - デフォルト値：practice
- **関連ファイル**：
  - 実装済み：作成、編集、詳細、一覧ページ
  - 未実装：`/src/components/search/PublicGameSearch.tsx`

### 2.4 試合進行管理機能

#### 2.4.1 メンバー管理（打順・守備位置）
- **機能ID**：PROGRESS-001
- **実装状態**：✅ 実装済み
- **機能概要**：試合メンバーの打順と守備位置設定
- **詳細仕様**：
  - 1〜9番までの打順設定
  - 守備位置の選択
  - デフォルトラインナップの保存/適用
  - ドラッグ&ドロップでの並び替え
- **関連ファイル**：
  - `/src/app/games/[gameId]/players/page.tsx`

#### 2.4.2 スコア入力
- **機能ID**：PROGRESS-002
- **実装状態**：✅ 実装済み
- **機能概要**：イニング毎のスコア入力
- **詳細仕様**：
  - 7回制対応
  - 自チーム攻撃回のみ詳細入力
  - インラインスコア編集
  - 試合終了時の自動ステータス更新
- **関連ファイル**：
  - `/src/app/games/[gameId]/page.tsx`（インライン編集）
- **注意事項**：
  - is_my_team_bat_firstで先攻/後攻を管理

#### 2.4.3 打撃成績入力
- **機能ID**：PROGRESS-003
- **実装状態**：✅ 実装済み
- **機能概要**：打者の打撃結果記録
- **詳細仕様**：
  - 打撃結果（日本語値で保存）：
    - 安打、二塁打、三塁打、本塁打
    - 四球、死球、三振、ゴロ、フライ
    - 犠打、犠飛、併殺打、三重殺打
  - 付随情報：
    - 打点数
    - 得点
    - 盗塁
    - 到達塁（0〜4）
    - メモ
  - ダブルプレー・トリプルプレー対応
- **関連ファイル**：
  - `/src/app/games/[gameId]/progress/page.tsx`
  - `/src/components/game/BattingRecordInput.tsx`
- **重要な動作**：
  - 3アウトで自動イニング交代
  - 併殺・三重殺時の正確なアウト計算

#### 2.4.4 ランナー管理
- **機能ID**：PROGRESS-004
- **実装状態**：✅ 実装済み
- **機能概要**：塁上ランナーの管理
- **詳細仕様**：
  - ダイヤモンド型UIでの表示
  - 機能：
    - 出塁時の到達塁選択
    - 各塁からの進塁/盗塁/得点
    - イニング交代時の自動クリア
  - 進塁ロジック：
    - 単打・四球：強制進塁のみ
    - 二塁打：全ランナー2塁進塁
    - 三塁打：全ランナー3塁進塁
    - 本塁打：全ランナーホームイン
- **関連ファイル**：
  - `/src/components/game/RunnerManagement.tsx`
- **データベース**：
  - `game_runners`テーブル

#### 2.4.5 投手成績入力
- **機能ID**：PROGRESS-005
- **実装状態**：✅ 実装済み
- **機能概要**：投手の成績記録
- **詳細仕様**：
  - 投球回（0.1刻み、野球独自表記）
  - 成績項目：
    - 被安打、奪三振、与四球、失点、自責点
  - 自動計算：
    - 防御率、WHIP、K/9、BB/9
- **関連ファイル**：
  - `/src/components/game/PitchingRecordInput.tsx`
- **注意事項**：
  - 0.1=1アウト、0.2=2アウト、0.3→1.0繰り上がり

#### 2.4.6 選手交代
- **機能ID**：PROGRESS-006
- **実装状態**：✅ 実装済み
- **機能概要**：試合中の選手交代
- **詳細仕様**：
  - 打順引き継ぎ
  - 交代選手の成績記録継続
- **関連ファイル**：
  - `/src/app/games/[gameId]/progress/page.tsx`

### 2.5 成績表示機能

#### 2.5.1 個人成績表示
- **機能ID**：STATS-001
- **実装状態**：✅ 実装済み
- **機能概要**：ユーザーの通算成績表示
- **詳細仕様**：
  - ダッシュボードに表示
  - 打撃成績：打率、本塁打、打点、OPS等
  - 投手成績：防御率、奪三振、WHIP、K/7、BB/7等
- **関連ファイル**：
  - `/src/app/dashboard/page.tsx`
  - `/src/components/stats/PersonalStats.tsx`

#### 2.5.2 チーム成績一覧
- **機能ID**：STATS-002
- **実装状態**：✅ 実装済み
- **機能概要**：チームメンバーの成績ランキング
- **詳細仕様**：
  - 全メンバーの打撃成績
  - 全メンバーの投手成績
  - ソート機能付きテーブル
- **関連ファイル**：
  - `/src/components/stats/TeamMemberStats.tsx`

#### 2.5.3 試合単位成績表示
- **機能ID**：STATS-003
- **実装状態**：✅ 実装済み
- **機能概要**：試合毎の成績表示
- **詳細仕様**：
  - ハイブリッドアプローチ：
    - 試合終了後：DBビューから取得
    - 試合進行中：クライアント側計算
- **関連ファイル**：
  - `/src/components/stats/StatsDisplay.tsx`

### 2.6 出欠確認機能

#### 2.6.1 出欠回答
- **機能ID**：ATTEND-001
- **実装状態**：✅ 実装済み
- **機能概要**：試合への出欠回答
- **詳細仕様**：
  - ステータス：
    - pending（未回答）- 初期値
    - attending（出席）
    - absent（欠席）
  - ゲスト（助っ人）追加機能
- **関連ファイル**：
  - `/src/app/games/[gameId]/page.tsx`
- **重要な制約**：
  - 初期値は必ず'pending'（変更禁止）

#### 2.6.2 出欠アラート
- **機能ID**：ATTEND-002
- **実装状態**：✅ 実装済み
- **機能概要**：未回答アラート表示
- **詳細仕様**：
  - ダッシュボードに表示
  - 表示条件：
    - attendance_check_enabled = true
    - status = 'scheduled' or 'in_progress'
    - game_date >= 今日
    - 自分のstatus = 'pending'
- **関連ファイル**：
  - `/src/app/dashboard/page.tsx`

### 2.7 運営タスク管理

#### 2.7.1 タスク登録
- **機能ID**：TASK-001
- **実装状態**：✅ 実装済み
- **機能概要**：試合運営タスクの登録
- **詳細仕様**：
  - タスクタイプ（9種類）：
    - equipment（用具管理）
    - scheduling（試合調整）
    - coordination（連絡調整）
    - ground（グラウンド手配）
    - attendance（出欠管理）
    - umpire（審判）
    - helper（助っ人手配）
    - media（撮影・記録）
    - accounting（会計）
  - 担当者：チームメンバーorテキスト入力
- **関連ファイル**：
  - `/src/app/games/[gameId]/operations/page.tsx`

#### 2.7.2 貢献度表示
- **機能ID**：TASK-002
- **実装状態**：✅ 実装済み
- **機能概要**：タスク実施者の貢献度表示
- **詳細仕様**：
  - 試合詳細ページに感謝メッセージ
  - チームページに年間貢献度ランキング
- **関連ファイル**：
  - `/src/app/teams/[teamId]/page.tsx`

### 2.8 検索機能

#### 2.8.1 チーム検索
- **機能ID**：SEARCH-001
- **実装状態**：✅ 実装済み
- **機能概要**：公開チームの検索
- **関連ファイル**：
  - `/src/app/search/teams/page.tsx`

#### 2.8.2 試合検索
- **機能ID**：SEARCH-002
- **実装状態**：⚠️ 一部未実装
- **機能概要**：公開試合の検索
- **詳細仕様**：
  - キーワード検索
  - ステータスフィルター
  - 日付範囲指定
  - カテゴリーフィルター（未実装）
- **関連ファイル**：
  - `/src/components/search/PublicGameSearch.tsx`

## 3. データベース仕様

### 3.1 主要テーブル

#### teams
- id, name, description, owner_id, created_at, updated_at

#### team_members
- id, team_id, user_id, joined_at
- **制約**：user_idはauth.usersを参照

#### games
- id, name, game_date, location, opponent_name
- home_team_id, home_score, opponent_score
- status（scheduled/in_progress/completed/cancelled）
- category（official/practice/scrimmage）
- is_public, attendance_check_enabled
- is_my_team_bat_first

#### game_players
- id, game_id, team_member_id, player_name
- batting_order, position

#### game_batting_records
- id, game_id, player_id, inning
- result（日本語値）, rbi, run_scored
- stolen_base, base_reached, notes

#### game_pitching_records
- id, game_id, player_id, innings_pitched
- hits_allowed, strikeouts, walks
- runs_allowed, earned_runs

#### game_runners
- id, game_id, inning, player_id
- current_base, is_active

#### game_attendances
- id, game_id, team_member_id, guest_name
- status（pending/attending/absent）

#### game_operation_tasks
- id, game_id, task_type, team_member_id, person_name

### 3.2 ビュー

#### player_batting_stats
- 打撃成績集計ビュー

#### player_pitching_stats
- 投手成績集計ビュー

## 4. ルーティング構造

### 4.1 認証関連
- `/login` - ログインページ
- `/profile/setup` - ユーザー名設定

### 4.2 ダッシュボード
- `/dashboard` - ダッシュボード
- `/dashboard/settings` - 設定

### 4.3 チーム関連
- `/teams` - チーム一覧
- `/teams/create` - チーム作成
- `/teams/[teamId]` - チーム詳細
- `/teams/[teamId]/edit` - チーム編集
- `/teams/[teamId]/games` - チーム試合一覧

### 4.4 試合関連
- `/games` - 試合管理
- `/games/create` - 試合作成
- `/games/[gameId]` - 試合詳細
- `/games/[gameId]/edit` - 試合編集
- `/games/[gameId]/players` - メンバー管理
- `/games/[gameId]/progress` - 試合進行管理
- `/games/[gameId]/operations` - 運営タスク管理

### 4.5 検索関連
- `/search/teams` - チーム検索
- `/search/games` - 試合検索

## 5. 重要な技術的制約と注意事項

### 5.1 絶対に変更してはいけない実装

#### 出欠確認の初期値
```typescript
// ⚠️ CRITICAL: この値を変更禁止
status: "pending" as const,  // 絶対に'attending'にしないこと
```

#### 認証状態チェック
```typescript
// ⚠️ CRITICAL: この条件を変更禁止
const { user, loading: authLoading } = useAuth();
useEffect(() => {
  if (authLoading) return;  // この行を削除しないこと
  if (!user) {
    router.push("/login");
    return;
  }
}, [user, authLoading]);
```

#### RLS制約によるJOIN禁止
```typescript
// ⚠️ CRITICAL: 直接JOINは禁止 - RLSで無限再帰
// ❌ NG: .select("*, user_profiles(*)")
// ⭕ OK: 別々に取得してクライアント側で結合
```

### 5.2 データベース設計の制約
- team_membersのuser_idはauth.usersを参照（user_profilesではない）
- user_profilesとteam_membersは直接JOIN不可
- game_batting_recordsのresultは日本語値で保存
- 投球回は0.1刻みで保存（野球独自表記）

### 5.3 機能追加・修正時のチェックリスト

#### 修正前チェック
- [ ] 修正対象ファイルの現在の全機能を把握
- [ ] 影響を受ける可能性のある関連ファイルを特定
- [ ] PROJECT_STATUS.mdで現在の状況を確認
- [ ] complete_source.txtで実装詳細を確認

#### 修正中チェック
- [ ] 修正対象以外のコードを変更していないか
- [ ] 削除する機能がないか確認
- [ ] 既存の条件分岐を削除していないか
- [ ] インポート文を変更・削除していないか

#### 修正後チェック
- [ ] すべての既存機能が動作するか
- [ ] 新機能が仕様通りに動作するか
- [ ] エラーハンドリングが適切か
- [ ] RLSポリシーとの整合性

## 6. 今後の実装予定

### 優先度：高
1. 試合検索ページのカテゴリー対応
2. 出欠確認機能の完成（9人以下警告）

### 優先度：中
1. ランナー管理の高度化
2. タッチアップ対応

### 優先度：低
1. リアルタイム更新機能
2. 対戦成績分析機能

## 7. バージョン履歴

### v1.0.0 (2025-08-24)
- 初版作成
- 実装済み機能の文書化
- 技術的制約の明文化

---

**この仕様書は生きたドキュメントです。機能追加・修正時は必ず更新してください。**